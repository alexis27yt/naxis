<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lista de Primera Despensa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#f8fafc">

<style>
  :root{
    /* Paleta & tokens */
    --bg:#f7f7fb; --bg2:#fefefe; --card:#ffffff; --card2:#fffdf9; --ring:#e7eaf3;
    --text:#334155; --muted:#6b7280; --brand:#a78bfa; --brand-2:#93c5fd;
    --success:#16a34a; --danger:#b91c1c; --warning:#b45309;
    --chip:#eef2ff; --chip-ring:#dbeafe;
    --item:#f8fafc; --item-checked:#e0f2fe; --item-exp:#fee2e2;
    --shadow: 0 6px 18px rgba(148,163,184,.18);
    --shadow-card: 0 10px 26px rgba(148,163,184,.22);
    --fs-xs:12px; --fs-sm:13px; --fs-md:14px; --fs-lg:16px;
    --hit:44px; --radius:12px; --radius-lg:16px; --gap:10px; --focus:#4f46e5;
  }

  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
    font-size: var(--fs-md); color:var(--text);
    background:
      radial-gradient(600px 300px at 100% -10%, rgba(167,139,250,.20), transparent 60%),
      radial-gradient(500px 260px at 0% 100%, rgba(147,197,253,.20), transparent 60%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    -webkit-tap-highlight-color: transparent;
  }

  .container{
    max-width: 860px; margin: 0 auto; padding: 12px 12px 120px; display:flex; flex-direction:column; gap:12px;
  }

  /* Toolbar */
  .toolbar{
    position:sticky; top:0; z-index:50; backdrop-filter: saturate(140%) blur(10px);
    background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.75));
    border-bottom:1px solid var(--ring);
  }
  .toolbar-inner{
    max-width: 860px; margin: 0 auto; padding: 8px 10px;
    display:grid; grid-template-columns: 1fr; gap:8px;
  }
  .brand-row{ display:flex; align-items:center; gap:8px; }
  h1{ font-size: var(--fs-lg); font-weight:800; letter-spacing:.2px; margin:0; color:#1f2937; }

  .search{
    display:flex; align-items:center; gap:8px; background:#ffffff; border:1px solid var(--ring);
    border-radius: var(--radius); padding: 8px 10px; box-shadow: var(--shadow);
  }
  .search input{ flex:1; background:transparent; border:0; outline:0; color:var(--text); font-size:var(--fs-md); }
  .search .icon-btn{
    width:36px; height:36px; border:1px solid var(--ring); background:#fff; border-radius:10px; display:grid; place-items:center; cursor:pointer;
  }

  .actions{ display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:2px; scroll-snap-type:x mandatory; }
  .actions .btn{ scroll-snap-align:start; flex:0 0 auto; }

  .btn{
    border:1px solid var(--ring); color:#1f2937; background:linear-gradient(180deg, #ffffff, #f4f6ff);
    padding:8px 10px; border-radius:var(--radius); cursor:pointer; font-weight:700;
    transition:.15s transform, .2s filter, .2s box-shadow; white-space:nowrap;
    box-shadow: var(--shadow); font-size:var(--fs-sm); touch-action: manipulation;
    min-height:var(--hit); display:inline-flex; align-items:center; gap:6px;
  }
  .btn svg{ width:16px; height:16px }
  .btn:hover{ transform:translateY(-1px); filter:brightness(1.03) }
  .btn:active{ transform:translateY(0) }
  .btn-print{ background:linear-gradient(180deg, #f5f3ff, #eef2ff); border-color:#ddd6fe }
  .btn-danger{ background:linear-gradient(180deg, #fff1f2, #ffe4e6); border-color:#fecaca }
  .btn-outline{ background:#fff; border-style:dashed }
  .btn:focus-visible,
  .toggle:focus-visible, .sort:focus-visible, .del:focus-visible, .check:focus-visible,
  input:focus-visible, select:focus-visible, .icon-btn:focus-visible, .seg-btn:focus-visible,
  .fab:focus-visible, .fab-mini:focus-visible{
    outline: 2px solid var(--focus); outline-offset: 2px;
  }

  /* Panel progreso + totales */
  .panel{
    background: linear-gradient(180deg, var(--card), var(--card2));
    border:1px solid var(--ring); border-radius:var(--radius-lg); padding:10px;
    display:flex; flex-direction:column; gap:10px; box-shadow: var(--shadow);
  }
  .progress{ height:16px; border-radius:999px; background:#f1f5f9; border:1px solid var(--ring); overflow:hidden; }
  .progress .bar{
    height:100%; width:0%; background: linear-gradient(90deg, var(--brand), var(--brand-2));
    display:flex; align-items:center; justify-content:center; font-size: var(--fs-xs); font-weight:900; letter-spacing:.2px;
    transition: width .4s cubic-bezier(.2,.8,.2,1); color:#0a0f1f;
  }

  .totales{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }
  .tcard{
    background:#fff; border:1px solid var(--ring); border-radius:var(--radius); text-align:center; padding:8px;
    min-height:var(--hit); display:flex; flex-direction:column; justify-content:center;
  }
  .tcard h4{ margin:0 0 3px 0; color:var(--muted); font-size:var(--fs-xs); font-weight:700; letter-spacing:.2px; text-transform:uppercase; }
  .tcard .val{ font-size:var(--fs-md); font-weight:900; color:#111827; }

  /* Filtro de vista (estado) */
  .filterbar{
    position:sticky; top:66px; z-index:49; background: rgba(255,255,255,.85); backdrop-filter: blur(6px);
    border:1px solid var(--ring); border-radius:999px; padding:6px; box-shadow: var(--shadow);
    display:flex; gap:6px; justify-content:center; align-items:center;
  }
  .seg-btn{
    border:1px solid var(--ring); background:#fff; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:800; font-size:var(--fs-sm);
  }
  .seg-btn.active{ background:#eef2ff; border-color:#c7d2fe; color:#1e3a8a; }

  /* Card categor√≠a */
  .card{
    background: linear-gradient(180deg, #ffffff, #fafafa);
    border:1px solid var(--ring); border-radius:var(--radius-lg); overflow:hidden; box-shadow: var(--shadow-card);
  }
  .card header{
    padding:10px; display:flex; align-items:center; justify-content:space-between; gap:8px;
    border-bottom:1px solid var(--ring);
  }
  .title{ display:flex; align-items:center; gap:8px; min-width:0; }
  .title h2{ margin:0; font-size:var(--fs-md); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:flex; align-items:center; gap:6px; }
  .contador{
    font-size:var(--fs-xs); background: var(--chip); border:1px solid var(--chip-ring); color:#3730a3;
    padding:2px 6px; border-radius:999px; font-weight:900;
  }
  .meta{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
  .sort{
    appearance:none; padding:6px 8px; border-radius:10px; border:1px solid var(--ring);
    background:#fff; color:#text; font-weight:700; cursor:pointer; min-width:140px; box-shadow: var(--shadow);
    font-size:var(--fs-sm); min-height:var(--hit);
  }
  .total-cat{
    background:#ecfeff; border:1px solid #bae6fd; color:#075985; font-weight:900; padding:6px 8px; border-radius:999px; white-space:nowrap;
    box-shadow: var(--shadow); font-size:var(--fs-sm); min-height:var(--hit); display:inline-flex; align-items:center;
  }

  .toggle{ border:1px solid var(--ring); background:#fff; border-radius:10px; width:var(--hit); height:var(--hit); display:grid; place-items:center; cursor:pointer; box-shadow: var(--shadow); }
  .chev{ transition: transform .2s ease; } .collapsed .chev{ transform: rotate(-90deg); }

  .items{ list-style:none; margin:0; padding:8px; display:flex; flex-direction:column; gap:8px; }
  .items.collapsed{ display:none; }

  .item{
    display:flex; align-items:center; gap:8px; background: var(--item);
    border:1px solid var(--ring); border-radius:var(--radius); padding:8px; transition: transform .15s ease, box-shadow .15s ease, background .2s ease; flex-wrap:wrap;
    min-height:var(--hit); touch-action: pan-y;
  }
  .item:hover{ box-shadow: 0 0 0 2px rgba(147,197,253,.30) inset }
  .item.checked{ background: var(--item-checked); }
  .item.expensive{ box-shadow: 0 0 0 2px rgba(185,28,28,.85) inset; background: var(--item-exp); }
  .item.pop{ animation: pop .18s ease; }
  @keyframes pop{ from{transform:scale(.98)} to{transform:scale(1)} }

  /* Checkbox compacto */
  .check{ width:20px; height:20px; min-width:20px; min-height:20px; cursor:pointer; accent-color:#8b5cf6; }

  .name{ flex:1 1 150px; min-width:120px; font-weight:700; letter-spacing:.2px; font-size:var(--fs-md); }

  .pc{ display:flex; align-items:center; gap:6px; flex:1 1 auto; flex-wrap:wrap; }
  .pc input[type="number"]{
    width:100px; background:#fff; border:1px solid var(--ring); border-radius:10px; padding:8px 10px; color:#111827; font-weight:700; font-size:var(--fs-sm);
    min-height:var(--hit);
  }
  .subtotal{
    min-width:110px; text-align:right; font-weight:900; background:#fff; border:1px solid var(--ring); border-radius:10px; padding:8px 10px;
    font-size:var(--fs-sm); min-height:var(--hit); display:flex; align-items:center; justify-content:flex-end;
  }
  .del{
    background:#fff1f2; border:1px solid #fecaca; color:#991b1b; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:900; font-size:var(--fs-sm);
    min-height:var(--hit); display:inline-flex; align-items:center;
  }
  .fav{
    background:#fff; border:1px solid #fde68a; color:#92400e; border-radius:10px; padding:8px 10px; cursor:pointer; font-weight:900; font-size:var(--fs-sm);
    min-height:var(--hit); display:inline-flex; align-items:center;
  }
  .item.fav-on .fav{ background:#fffbeb; border-color:#f59e0b; color:#7c2d12 }

  /* Admin */
  .admin{
    background: linear-gradient(180deg, var(--card), #fdfcff);
    border:1px solid var(--ring); border-radius:var(--radius-lg); padding:10px; display:flex; flex-direction:column; gap:8px; box-shadow: var(--shadow);
  }
  .admin h3{ margin:0; font-size:var(--fs-md); color:#1f2937; letter-spacing:.2px }
  .admin .group{ display:flex; flex-wrap:wrap; gap:8px }
  .admin input[type="text"], .admin select{
    background:#fff; border:1px solid var(--ring); color:var(--text); padding:8px 10px; border-radius:var(--radius); font-weight:700; box-shadow: var(--shadow);
    font-size:var(--fs-sm); min-height:var(--hit);
  }
  .admin .note{ font-size:var(--fs-xs); color:var(--muted) }

  /* Overlay confirmaci√≥n */
  .overlay{
    position:fixed; inset:0; z-index:90; background: rgba(2,6,23,.20);
    display:flex; align-items:center; justify-content:center; backdrop-filter: blur(2px);
  }
  .confirm{
    background:#fff; border:1px solid var(--ring); color:var(--text); padding:14px; border-radius:var(--radius-lg); width:min(92vw,420px);
    box-shadow: var(--shadow-card); text-align:center; font-size:var(--fs-md);
  }
  .confirm p{ margin:0 0 10px 0 }
  .confirm .row{ display:flex; gap:8px; justify-content:center }
  .cbtn{ padding:8px 10px; border-radius:var(--radius); cursor:pointer; font-weight:900; border:1px solid var(--ring); box-shadow: var(--shadow); font-size:var(--fs-sm) }
  .cbtn.y{ background:#fee2e2; color:#7f1d1d; border-color:#fecaca }
  .cbtn.n{ background:#eef2ff; color:#1e3a8a; border-color:#c7d2fe }

  /* Bottom bar */
  .bottom-bar{
    position:fixed; left:0; right:0; bottom:0; z-index:60; background:rgba(255,255,255,.98); border-top:1px solid var(--ring); backdrop-filter: blur(6px);
    display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 12px; padding-bottom: calc(8px + env(safe-area-inset-bottom));
  }
  .bb-metrics{ display:flex; gap:10px; align-items:center; font-size:var(--fs-sm); }
  .bb-chip{
    background:#fff; border:1px solid var(--ring); border-radius:999px; padding:8px 10px; box-shadow: var(--shadow);
    display:flex; gap:6px; align-items:center; font-weight:800; min-height:var(--hit);
  }
  .bb-chip strong{ font-weight:900; }
  .share-row{ display:flex; gap:8px }

  /* Update banner */
  .update-banner{
    position: fixed; left:50%; transform: translateX(-50%);
    bottom: calc(56px + env(safe-area-inset-bottom)); z-index:70;
    background:#111827; color:#fff; border:1px solid #0b1224; border-radius:999px; padding:8px 12px;
    box-shadow: var(--shadow-card); display:none; align-items:center; gap:10px;
  }
  .update-banner .btn{ background:#10b981; border-color:#065f46; color:#06281c; }
  .update-banner .btn-cancel{ background:#e5e7eb; border-color:#cbd5e1; color:#111827; }

  /* FABs flotantes */
  .fab-stack{ position:fixed; right:16px; bottom:96px; z-index:65; display:flex; flex-direction:column; gap:10px; }
  .fab, .fab-mini{ border:1px solid var(--ring); background:#fff; box-shadow: var(--shadow-card); cursor:pointer; display:grid; place-items:center; }
  .fab{ width:56px; height:56px; border-radius:50%; }
  .fab-mini{ width:44px; height:44px; border-radius:12px; opacity:.0; pointer-events:none; transform: translateY(10px); transition: .18s ease; }
  .fab-speed.open .fab-mini{ opacity:1; pointer-events:auto; transform: translateY(0); }

  /* Sheet b√∫squeda */
  .sheet{
    position:fixed; left:0; right:0; bottom:-100%; z-index:80; background:#fff; border-top:1px solid var(--ring);
    box-shadow: 0 -10px 26px rgba(0,0,0,.12); transition: transform .25s ease; transform: translateY(100%);
    padding:12px; padding-bottom: calc(12px + env(safe-area-inset-bottom));
  }
  .sheet.open{ transform: translateY(0); bottom:0; }
  .sheet-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .sheet h3{ margin:0; font-size:var(--fs-md); }
  .sheet .input{ display:flex; align-items:center; gap:8px; border:1px solid var(--ring); background:#fff; border-radius:var(--radius); padding:10px; box-shadow: var(--shadow); }
  .sheet input{ flex:1; border:0; outline:0; font-size:var(--fs-md); }

  /* Modal nuevo producto */
  .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.25); backdrop-filter: blur(2px); z-index:95; display:none; align-items:center; justify-content:center; }
  .modal{ background:#fff; border:1px solid var(--ring); border-radius:var(--radius-lg); width:min(92vw, 460px); box-shadow: var(--shadow-card); padding:12px; }
  .modal h3{ margin:0 0 8px 0; font-size:var(--fs-lg); }
  .modal .grid{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .modal .grid .full{ grid-column:1 / -1; }
  .modal label{ display:block; font-size:var(--fs-xs); color:var(--muted); margin-bottom:4px; }
  .modal input, .modal select{ width:100%; border:1px solid var(--ring); border-radius:var(--radius); padding:10px; font-size:var(--fs-md); }
  .modal .row{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
  .modal .btn{ min-height:var(--hit); }

  /* Scanner */
  .scan-video{ width:100%; border-radius:12px; background:#000; aspect-ratio: 3/4; object-fit:cover; }

  /* QR Export */
  .qr-wrap{ display:flex; flex-direction:column; align-items:center; gap:10px }
  #qr-canvas{ width:min(82vw, 380px); height:auto; image-rendering: pixelated; border:10px solid #fff; box-shadow: var(--shadow-card); border-radius:12px; background:#fff }
  .qr-meta{ font-size: var(--fs-sm); color:#6b7280; text-align:center }

  /* Onboarding tips */
  .tip{
    position:fixed; z-index:85; background:#111827; color:#fff; padding:10px 12px; border-radius:12px; box-shadow: var(--shadow-card); max-width:280px; font-size:var(--fs-sm);
  }
  .tip .actions{ margin-top:8px; display:flex; gap:8px; }
  .tip .actions .btn{ background:#10b981; border-color:#065f46; color:#06281c; }
  .tip .actions .btn-outline{ background:#e5e7eb; border-color:#cbd5e1; color:#111827; }

  @media (min-width:640px){
    :root{ --fs-xs:12px; --fs-sm:13px; --fs-md:15px; --fs-lg:18px; }
    .toolbar-inner{ grid-template-columns: 1fr 1fr; align-items:center }
    .actions{ justify-content:flex-end; overflow:visible }
  }

  @media (prefers-reduced-motion: reduce){
    *{ animation:none !important; transition:none !important }
  }
</style>
</head>
<body>

<!-- TOOLBAR -->
<div class="toolbar">
  <div class="toolbar-inner">
    <div class="brand-row"><h1>Primera Despensa</h1></div>

    <div class="search" role="search" aria-label="Buscar producto">
      <svg width="16" height="16" fill="none" stroke="#94a3b8" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 21l-4.35-4.35"/><circle cx="10" cy="10" r="7"/></svg>
      <input id="busqueda" placeholder="Buscar producto‚Ä¶">
      <button class="icon-btn" id="btn-mic-top" title='Hablar: "Agrega dos salsa de tomate a 91"' aria-label="Buscar por voz">
        üé§
      </button>
    </div>

    <div class="actions" role="group" aria-label="Acciones">
      <button class="btn" id="btn-expandir" title="Expandir todo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M12 5v14M5 12h14"/></svg>Expandir</button>
      <button class="btn btn-outline" id="btn-colapsar" title="Colapsar todo"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M5 12h14"/></svg>Colapsar</button>
      <button class="btn" id="btn-compartir" title="Compartir resumen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7M16 6l-4-4-4 4M12 2v14"/></svg>Compartir</button>
      <button class="btn btn-print" id="btn-imprimir" title="Imprimir / guardar PDF"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M6 9V2h12v7M6 18h12v4H6zM6 14h12a2 2 0 002-2v-1a2 2 0 00-2-2H6a2 2 0 00-2 2z"/></svg>Imprimir</button>
      <button class="btn" id="btn-exportar" title="Exportar lista como QR">‚¨ÜÔ∏è Exportar</button>
      <button class="btn" id="btn-importar" title="Importar desde QR">‚¨áÔ∏è Importar</button>
      <button class="btn btn-danger" id="btn-borrar" title="Borrar estado"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M3 6h18M8 6V4h8v2M6 6l1 14h10l1-14"/></svg>Borrar</button>
      <button class="btn" id="btn-instalar" style="display:none;" title="Instalar app"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M12 3v12m0 0l-4-4m4 4l4-4M5 21h14"/></svg>Instalar</button>
    </div>
  </div>
</div>

<div class="container">

  <!-- PANEL DE PROGRESO + TOTALES -->
  <section class="panel" aria-labelledby="resumen">
    <h2 id="resumen" class="sr-only" style="position:absolute;left:-9999px">Resumen</h2>
    <div class="progress" aria-live="polite" aria-label="Progreso de selecci√≥n">
      <div class="bar" id="barra-progreso">0%</div>
    </div>
    <div class="totales" aria-live="polite">
      <div class="tcard" role="status" aria-live="polite"><h4>Seleccionados</h4><div class="val" id="total-seleccionados">0</div></div>
      <div class="tcard" role="status" aria-live="polite"><h4>Cantidad</h4><div class="val" id="total-cantidad">0</div></div>
      <div class="tcard" role="status" aria-live="polite"><h4>Total</h4><div class="val" id="total-dinero">$0.00</div></div>
    </div>
  </section>

  <!-- Filtro por estado -->
  <section class="filterbar" role="group" aria-label="Filtrar por estado">
    <button class="seg-btn" data-view="todos" id="view-todos">Todos</button>
    <button class="seg-btn" data-view="pendientes" id="view-pend">Pendientes</button>
    <button class="seg-btn" data-view="marcados" id="view-mark">Marcados</button>
    <button class="seg-btn" data-view="favoritos" id="view-fav">Favoritos</button>
  </section>

  <!-- ADMIN -->
  <section class="admin" aria-labelledby="admin-title">
    <h3 id="admin-title">Agregar / Quitar productos</h3>
    <div class="group">
      <input type="text" id="nuevo-producto" placeholder="Nombre del producto" aria-label="Nombre del producto" enterkeyhint="done">
      <select id="categoria-nueva" aria-label="Categor√≠a">
        <option value="higiene">Higiene Personal</option>
        <option value="limpieza">Limpieza del Hogar</option>
        <option value="alimentos">Alimentos B√°sicos</option>
        <option value="conservas">Conservas</option>
        <option value="otros">Otros</option>
      </select>
      <button class="btn" id="agregar-producto"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M12 5v14M5 12h14"/></svg>Agregar</button>
    </div>
    <small class="note">Se guarda autom√°ticamente en tu navegador.</small>
  </section>

  <!-- CATEGOR√çAS (IDs √∫nicos por categor√≠a: cat__slug) -->
  <!-- Higiene -->
  <section class="card higiene" data-cat="higiene">
    <header>
      <div class="title">
        <button class="toggle" aria-label="Colapsar/Expandir" aria-expanded="true">
          <svg class="chev" width="18" height="18" viewBox="0 0 24 24" stroke="#64748b" fill="none" stroke-width="2" aria-hidden="true"><path d="M6 9l6 6 6-6"/></svg>
        </button>
        <h2>Higiene Personal <span class="contador"></span></h2>
      </div>
      <div class="meta">
        <select class="sort" aria-label="Orden de Higiene">
          <option value="none">Ordenar‚Ä¶</option>
          <option value="nombre">Nombre (A‚ÄìZ)</option>
          <option value="costo">Costo unitario (‚Üë)</option>
          <option value="subtotal">Subtotal (‚Üë)</option>
          <option value="checked">Marcados primero</option>
        </select>
        <span class="total-cat" data-cat="higiene">$0.00</span>
      </div>
    </header>
    <ul class="items">
      <li class="item"><input class="check" type="checkbox" id="higiene__jabon-de-tocador"><div class="name"><label for="higiene__jabon-de-tocador">Jab√≥n de tocador</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="higiene__jabon-liquido-para-manos"><div class="name"><label for="higiene__jabon-liquido-para-manos">Jab√≥n l√≠quido para manos</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="higiene__shampoo"><div class="name"><label for="higiene__shampoo">Shampoo</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="higiene__pasta-dental"><div class="name"><label for="higiene__pasta-dental">Pasta dental</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="higiene__cepillo-de-dientes"><div class="name"><label for="higiene__cepillo-de-dientes">Cepillo de dientes</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="higiene__papel-higienico"><div class="name"><label for="higiene__papel-higienico">Papel higi√©nico</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="higiene__toallitas-humedas"><div class="name"><label for="higiene__toallitas-humedas">Toallitas h√∫medas</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="higiene__toallas-femeninas-tampones"><div class="name"><label for="higiene__toallas-femeninas-tampones">Toallas femeninas / tampones</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="higiene__desodorante"><div class="name"><label for="higiene__desodorante">Desodorante</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="higiene__gel-antibacterial"><div class="name"><label for="higiene__gel-antibacterial">Gel antibacterial</label></div></li>
    </ul>
  </section>

  <!-- Limpieza -->
  <section class="card limpieza" data-cat="limpieza">
    <header>
      <div class="title">
        <button class="toggle" aria-label="Colapsar/Expandir" aria-expanded="true">
          <svg class="chev" width="18" height="18" viewBox="0 0 24 24" stroke="#64748b" fill="none" stroke-width="2" aria-hidden="true"><path d="M6 9l6 6 6-6"/></svg>
        </button>
        <h2>Limpieza del Hogar <span class="contador"></span></h2>
      </div>
      <div class="meta">
        <select class="sort" aria-label="Orden de Limpieza">
          <option value="none">Ordenar‚Ä¶</option>
          <option value="nombre">Nombre (A‚ÄìZ)</option>
          <option value="costo">Costo unitario (‚Üë)</option>
          <option value="subtotal">Subtotal (‚Üë)</option>
          <option value="checked">Marcados primero</option>
        </select>
        <span class="total-cat" data-cat="limpieza">$0.00</span>
      </div>
    </header>
    <ul class="items">
      <li class="item"><input class="check" type="checkbox" id="limpieza__detergente-para-ropa"><div class="name"><label for="limpieza__detergente-para-ropa">Detergente para ropa</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="limpieza__suavizante-de-ropa"><div class="name"><label for="limpieza__suavizante-de-ropa">Suavizante de ropa</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="limpieza__cloro-lejia"><div class="name"><label for="limpieza__cloro-lejia">Cloro / lej√≠a</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="limpieza__limpiador-multiusos"><div class="name"><label for="limpieza__limpiador-multiusos">Limpiador multiusos</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="limpieza__escoba"><div class="name"><label for="limpieza__escoba">Escoba</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="limpieza__trapeador"><div class="name"><label for="limpieza__trapeador">Trapeador</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="limpieza__bolsas-de-basura"><div class="name"><label for="limpieza__bolsas-de-basura">Bolsas de basura</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="limpieza__esponja-estropajo"><div class="name"><label for="limpieza__esponja-estropajo">Esponja / estropajo</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="limpieza__desinfectante"><div class="name"><label for="limpieza__desinfectante">Desinfectante</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="limpieza__guantes-de-limpieza"><div class="name"><label for="limpieza__guantes-de-limpieza">Guantes de limpieza</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="limpieza__limpiavidrios"><div class="name"><label for="limpieza__limpiavidrios">Limpiavidrios</label></div></li>
    </ul>
  </section>

  <!-- Alimentos -->
  <section class="card alimentos" data-cat="alimentos">
    <header>
      <div class="title">
        <button class="toggle" aria-label="Colapsar/Expandir" aria-expanded="true">
          <svg class="chev" width="18" height="18" viewBox="0 0 24 24" stroke="#64748b" fill="none" stroke-width="2" aria-hidden="true"><path d="M6 9l6 6 6-6"/></svg>
        </button>
        <h2>Alimentos B√°sicos <span class="contador"></span></h2>
      </div>
      <div class="meta">
        <select class="sort" aria-label="Orden de Alimentos">
          <option value="none">Ordenar‚Ä¶</option>
          <option value="nombre">Nombre (A‚ÄìZ)</option>
          <option value="costo">Costo unitario (‚Üë)</option>
          <option value="subtotal">Subtotal (‚Üë)</option>
          <option value="checked">Marcados primero</option>
        </select>
        <span class="total-cat" data-cat="alimentos">$0.00</span>
      </div>
    </header>
    <ul class="items">
      <li class="item"><input class="check" type="checkbox" id="alimentos__arroz"><div class="name"><label for="alimentos__arroz">Arroz</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="alimentos__frijol"><div class="name"><label for="alimentos__frijol">Frijol</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="alimentos__aceite"><div class="name"><label for="alimentos__aceite">Aceite</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="alimentos__sal"><div class="name"><label for="alimentos__sal">Sal</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="alimentos__azucar"><div class="name"><label for="alimentos__azucar">Az√∫car</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="alimentos__harina"><div class="name"><label for="alimentos__harina">Harina</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="alimentos__cafe-te"><div class="name"><label for="alimentos__cafe-te">Caf√© / t√©</label></div></li>
    </ul>
  </section>

  <!-- Conservas -->
  <section class="card conservas" data-cat="conservas">
    <header>
      <div class="title">
        <button class="toggle" aria-label="Colapsar/Expandir" aria-expanded="true">
          <svg class="chev" width="18" height="18" viewBox="0 0 24 24" stroke="#64748b" fill="none" stroke-width="2" aria-hidden="true"><path d="M6 9l6 6 6-6"/></svg>
        </button>
        <h2>Conservas <span class="contador"></span></h2>
      </div>
      <div class="meta">
        <select class="sort" aria-label="Orden de Conservas">
          <option value="none">Ordenar‚Ä¶</option>
          <option value="nombre">Nombre (A‚ÄìZ)</option>
          <option value="costo">Costo unitario (‚Üë)</option>
          <option value="subtotal">Subtotal (‚Üë)</option>
          <option value="checked">Marcados primero</option>
        </select>
        <span class="total-cat" data-cat="conservas">$0.00</span>
      </div>
    </header>
    <ul class="items">
      <li class="item"><input class="check" type="checkbox" id="conservas__atun-en-lata"><div class="name"><label for="conservas__atun-en-lata">At√∫n en lata</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="conservas__sopa-instantanea-sobres"><div class="name"><label for="conservas__sopa-instantanea-sobres">Sopa instant√°nea / sopas en sobre</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="conservas__vegetales-enlatados"><div class="name"><label for="conservas__vegetales-enlatados">Vegetales enlatados</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="conservas__frutas-enlatadas"><div class="name"><label for="conservas__frutas-enlatadas">Frutas enlatadas</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="conservas__miel-mantequilla"><div class="name"><label for="conservas__miel-mantequilla">Miel / mantequilla</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="conservas__jugo-en-caja"><div class="name"><label for="conservas__jugo-en-caja">Jugo en caja</label></div></li>
    </ul>
  </section>

  <!-- Otros -->
  <section class="card otros" data-cat="otros">
    <header>
      <div class="title">
        <button class="toggle" aria-label="Colapsar/Expandir" aria-expanded="true">
          <svg class="chev" width="18" height="18" viewBox="0 0 24 24" stroke="#64748b" fill="none" stroke-width="2" aria-hidden="true"><path d="M6 9l6 6 6-6"/></svg>
        </button>
        <h2>Otros <span class="contador"></span></h2>
      </div>
      <div class="meta">
        <select class="sort" aria-label="Orden de Otros">
          <option value="none">Ordenar‚Ä¶</option>
          <option value="nombre">Nombre (A‚ÄìZ)</option>
          <option value="costo">Costo unitario (‚Üë)</option>
          <option value="subtotal">Subtotal (‚Üë)</option>
          <option value="checked">Marcados primero</option>
        </select>
        <span class="total-cat" data-cat="otros">$0.00</span>
      </div>
    </header>
    <ul class="items">
      <li class="item"><input class="check" type="checkbox" id="otros__pilas"><div class="name"><label for="otros__pilas">Pilas</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="otros__velas"><div class="name"><label for="otros__velas">Velas</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="otros__cerillos-encendedores"><div class="name"><label for="otros__cerillos-encendedores">Cerillos / encendedores</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="otros__panales"><div class="name"><label for="otros__panales">Pa√±ales</label></div></li>
      <li class="item"><input class="check" type="checkbox" id="otros__toallitas-bebe"><div class="name"><label for="otros__toallitas-bebe">Toallitas beb√©</label></div></li>
    </ul>
  </section>

</div>

<!-- BARRA INFERIOR -->
<div class="bottom-bar" role="region" aria-label="Resumen r√°pido">
  <div class="bb-metrics">
    <div class="bb-chip">‚úì <strong id="bb-sel">0</strong></div>
    <div class="bb-chip">$ <strong id="bb-total">0.00</strong></div>
  </div>
  <div class="share-row">
    <button class="btn" id="btn-compartir-bottom" title="Compartir resumen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7M16 6l-4-4-4 4M12 2v14"/></svg>Compartir</button>
    <button class="btn btn-print" id="btn-imprimir-bottom" title="Imprimir / guardar PDF"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path d="M6 9V2h12v7M6 18h12v4H6zM6 14h12a2 2 0 002-2v-1a2 2 0 00-2-2H6a2 2 0 00-2 2z"/></svg>Imprimir</button>
    <button class="btn" id="btn-exportar-bottom" title="Exportar lista como QR">‚¨ÜÔ∏è Exportar</button>
    <button class="btn" id="btn-importar-bottom" title="Importar desde QR">‚¨áÔ∏è Importar</button>
  </div>
</div>

<!-- FABs: Add + Speed dial + Search -->
<div class="fab-stack">
  <button class="fab" id="fab-add" aria-label="Agregar producto">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
  </button>

  <div class="fab-speed" id="fab-speed">
    <button class="fab" id="fab-more" aria-label="M√°s acciones">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
    </button>
    <div class="fab-mini-list">
      <button class="fab-mini" id="fab-expand" title="Expandir todo" aria-label="Expandir todo"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg></button>
      <button class="fab-mini" id="fab-collapse" title="Colapsar todo" aria-label="Colapsar todo"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2"><path d="M5 12h14"/></svg></button>
      <button class="fab-mini" id="fab-share" title="Compartir" aria-label="Compartir"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2"><path d="M4 12v7a1 1 0 001 1h14a1 1 0 001-1v-7M16 6l-4-4-4 4M12 2v14"/></svg></button>
      <button class="fab-mini" id="fab-print" title="Imprimir" aria-label="Imprimir"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2"><path d="M6 9V2h12v7M6 18h12v4H6zM6 14h12a2 2 0 002-2v-1a2 2 0 00-2-2H6a2 2 0 00-2 2z"/></svg></button>
      <button class="fab-mini" id="fab-export" title="Exportar QR" aria-label="Exportar QR">‚¨ÜÔ∏è</button>
      <button class="fab-mini" id="fab-import" title="Importar QR" aria-label="Importar QR">‚¨áÔ∏è</button>
      <button class="fab-mini" id="fab-scan" title="Escanear c√≥digo" aria-label="Escanear c√≥digo">üì∑</button>
      <button class="fab-mini" id="fab-favs" title="Ver favoritos" aria-label="Ver favoritos">‚≠ê</button>
    </div>
  </div>

  <button class="fab" id="fab-search" aria-label="Buscar">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="2"><path d="M21 21l-4.35-4.35"/><circle cx="10" cy="10" r="7"/></svg>
  </button>
</div>

<!-- Sheet de b√∫squeda -->
<div class="sheet" id="search-sheet" role="dialog" aria-modal="true" aria-labelledby="sheet-title">
  <div class="sheet-header">
    <h3 id="sheet-title">Buscar</h3>
    <button class="btn btn-outline" id="sheet-close">Cerrar</button>
  </div>
  <div class="input">
    <svg width="18" height="18" fill="none" stroke="#94a3b8" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 21l-4.35-4.35"/><circle cx="10" cy="10" r="7"/></svg>
    <input id="busqueda-sheet" placeholder='Di: "Agrega dos salsa de tomate a 91"' enterkeyhint="search" aria-label="Buscar en la lista">
    <button class="icon-btn" id="btn-mic-sheet" title='Hablar: "Agrega dos salsa de tomate a 91"' aria-label="Buscar por voz">üé§</button>
  </div>
</div>

<!-- Modal nuevo producto -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <h3 id="modal-title">Nuevo producto</h3>
    <div class="grid">
      <div class="full"><label for="m-nombre">Nombre</label><input id="m-nombre" type="text" placeholder="Ej. Leche entera"></div>
      <div><label for="m-categoria">Categor√≠a</label>
        <select id="m-categoria">
          <option value="higiene">Higiene Personal</option><option value="limpieza">Limpieza del Hogar</option><option value="alimentos">Alimentos B√°sicos</option><option value="conservas">Conservas</option><option value="otros">Otros</option>
        </select>
      </div>
      <div><label for="m-cant">Cantidad</label><input id="m-cant" type="number" min="0" step="1" inputmode="numeric" placeholder="1" enterkeyhint="done"></div>
      <div><label for="m-precio">Precio</label><input id="m-precio" type="number" min="0" step="0.01" inputmode="decimal" placeholder="0.00" enterkeyhint="done"></div>
    </div>
    <div class="row">
      <button class="btn btn-outline" id="modal-cancelar">Cancelar</button>
      <button class="btn" id="modal-guardar">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal scanner (alta de producto con c√≥digos) -->
<div class="modal-overlay" id="scan-overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="scan-title">
    <h3 id="scan-title">Escanear c√≥digo</h3>
    <video class="scan-video" id="scan-video" autoplay playsinline muted></video>
    <div class="row">
      <button class="btn btn-outline" id="scan-cancel">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal EXPORT QR -->
<div class="modal-overlay" id="qr-overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="qr-title">
    <h3 id="qr-title">Exportar lista (QR)</h3>
    <div class="qr-wrap">
      <canvas id="qr-canvas" width="820" height="820" aria-label="C√≥digo QR de exportaci√≥n"></canvas>
      <div class="qr-meta">Escan√©alo con <b>Importar</b> desde otro dispositivo.<br>Incluye art√≠culos + interfaz. ECC <b>H</b>, alto contraste, quiet zone amplia.</div>
    </div>
    <div class="row">
      <button class="btn btn-outline" id="qr-close">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal IMPORT (escaneo QR de exportaci√≥n) -->
<div class="modal-overlay" id="import-overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="import-title">
    <h3 id="import-title">Importar desde QR</h3>
    <video class="scan-video" id="import-video" autoplay playsinline muted></video>
    <div class="row">
      <button class="btn btn-outline" id="import-cancel">Cerrar</button>
    </div>
  </div>
</div>

<!-- Banner actualizaci√≥n SW -->
<div id="update-banner" class="update-banner" role="status" aria-live="polite">
  <span>Hay una nueva versi√≥n</span>
  <button class="btn" id="btn-update">Actualizar</button>
  <button class="btn btn-cancel" id="btn-update-cancel">Cerrar</button>
</div>

<script>
/* ====== Helpers ====== */
const money = v => (isFinite(v)?Number(v):0).toLocaleString('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:2});
const qS=(s,c=document)=>c.querySelector(s);
const qSA=(s,c=document)=>Array.from(c.querySelectorAll(s));
const LS_KEY='despensa_v7_state';
const UI_KEY='despensa_v7_ui';
let currentSearch=''; let currentView='todos';

const haptics = ms => { try{ if(navigator.vibrate) navigator.vibrate(ms); }catch{} };
const getCat = (card)=> card?.getAttribute('data-cat') || [...card.classList].find(c=>['higiene','limpieza','alimentos','conservas','otros'].includes(c));
const slug = (t)=> String(t||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
const idKey = (cat,name)=> `${cat}__${slug(name)}`;

/* ====== Estado (localStorage) ====== */
function readState(){
  const data=[];
  qSA('.card').forEach(card=>{
    const cat=getCat(card);
    qSA('.items > .item', card).forEach(li=>{
      const chk = qS('.check', li);
      const label = li.querySelector('label');
      const id = chk?.id || idKey(cat, label?.textContent.trim()||'');
      const cant = Number(qS('input.cant', li)?.value)||0;
      const cost = Number(qS('input.precio', li)?.value)||0;
      const fav = li.classList.contains('fav-on');
      data.push({ id, nombre: label?.textContent.trim()||'', categoria:cat, checked:!!chk?.checked, cantidad:cant, costo:cost, fav });
    });
  });
  return data;
}
function saveState(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(readState())); }catch{} }
function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'null'); }catch{ return null; } }

/* ====== Migraci√≥n ====== */
function migrateState(state){
  if(!Array.isArray(state)) return [];
  const migrated=state.map(it=>{
    let {id, nombre, categoria, fav=false} = it;
    categoria = categoria || 'otros';
    if(!id || !id.includes('__')) id = idKey(categoria, nombre);
    if(id.split('__')[1] !== slug(nombre)) id = idKey(categoria, nombre);
    return {...it, id, categoria, fav: !!fav};
  });
  return migrated;
}

/* ====== Reconstrucci√≥n de √≠tems perdidos ====== */
function ensureItemFromState(it){
  if(!it || !it.id || !it.nombre) return;
  const cat = it.categoria || 'otros';
  const ul = qS(`.card.${cat} .items`);
  if(!ul) return;
  let li = document.getElementById(it.id);
  li = li ? li.closest('.item') : null;

  if(!li){
    li = document.createElement('li');
    li.className='item';
    li.innerHTML = `<input class="check" type="checkbox" id="${it.id}">
                    <div class="name"><label for="${it.id}">${it.nombre}</label></div>`;
    ul.appendChild(li);
    ensureControls(li);
  }
  const chk = qS('.check', li); if(chk) chk.checked = !!it.checked;
  const inQ = qS('input.cant', li); if(inQ) inQ.value = it.cantidad ?? 1;
  const inP = qS('input.precio', li); if(inP) inP.value = it.costo ?? 0;
  li.classList.toggle('checked', !!it.checked);
  li.classList.toggle('fav-on', !!it.fav);
}
function rebuildFromState(state){ (state||[]).forEach(ensureItemFromState); }

/* ====== Aplicar estado existente ====== */
function applyState(state){
  if(!state) return;
  const map = new Map(state.map(i=>[i.id,i]));
  qSA('.card').forEach(card=>{
    qSA('.items > .item', card).forEach(li=>{
      ensureControls(li);
      const chk = qS('.check', li);
      const label = li.querySelector('label');
      const cat = getCat(card);
      const id = chk?.id || idKey(cat, label?.textContent.trim()||'');
      const item = map.get(id);
      if(!item) return;
      if(chk) chk.checked = !!item.checked;
      const cant = qS('input.cant', li); if(cant) cant.value = item.cantidad ?? 1;
      const precio = qS('input.precio', li); if(precio) precio.value = item.costo ?? 0;
      li.classList.toggle('checked', chk?.checked);
      li.classList.toggle('fav-on', !!item.fav);
    });
  });
  updateAll();
}

/* ====== UI persistencia ====== */
function readUI(){ try{ return JSON.parse(localStorage.getItem(UI_KEY)||'{}'); }catch{ return {}; } }
function writeUI(ui){ try{ localStorage.setItem(UI_KEY, JSON.stringify(ui)); }catch{} }

/* ====== Controles por √≠tem ====== */
function ensureControls(li){
  if(qS('.pc', li)) return;
  const pc = document.createElement('div'); pc.className='pc';

  const inQ=document.createElement('input'); inQ.type='number'; inQ.className='cant';
  inQ.min='0'; inQ.step='1'; inQ.value='1'; inQ.title='Cantidad'; inQ.placeholder='Cant.'; inQ.inputMode='numeric'; inQ.setAttribute('enterkeyhint','done');

  const inP=document.createElement('input'); inP.type='number'; inP.className='precio';
  inP.min='0'; inP.step='0.01'; inP.placeholder='Costo $'; inP.title='Costo unitario (MXN)'; inP.inputMode='decimal'; inP.setAttribute('enterkeyhint','done');

  const sub=document.createElement('div'); sub.className='subtotal'; sub.textContent=money(0);
  const fav=document.createElement('button'); fav.className='fav'; fav.type='button'; fav.textContent='‚≠ê';
  const del=document.createElement('button'); del.className='del'; del.type='button'; del.textContent='Eliminar';

  pc.append(inQ,inP,sub,fav,del); li.appendChild(pc);

  const recalc=()=>{ sub.textContent=money((Number(inQ.value)||0)*(Number(inP.value)||0)); updateAll(); saveState(); };
  inQ.addEventListener('input', recalc); inP.addEventListener('input', recalc);

  const chk=qS('.check', li);
  if(chk){
    chk.addEventListener('change',()=>{
      li.classList.toggle('checked', chk.checked);
      li.classList.add('pop');
      setTimeout(()=>li.classList.remove('pop'), 200);
      updateAll(); saveState(); haptics(15);
    });
  }
  fav.addEventListener('click', ()=>{ li.classList.toggle('fav-on'); saveState(); applyViewFilter(currentView); });
  del.addEventListener('click',()=>{
    const name=li.querySelector('label')?.textContent.trim()||'el producto';
    confirmUI(`¬øEliminar ‚Äú${name}‚Äù?`, ()=>{ li.remove(); updateAll(); saveState(); haptics(30); });
  });

  addGestures(li);
}

/* ====== Gestos ====== */
function addGestures(li){
  let startX=0, startY=0, dx=0, active=false, swiping=false, tapTimer=null;
  const onStart = (e)=>{ const t=e.touches? e.touches[0] : e; startX=t.clientX; startY=t.clientY; dx=0; active=true; swiping=false; li.style.transition='none'; };
  const onMove = (e)=>{ if(!active) return; const t=e.touches? e.touches[0] : e; const dy=Math.abs(t.clientY-startY); dx = t.clientX-startX;
    if(dy<10 && Math.abs(dx)>8){ swiping=true; e.preventDefault(); }
    if(swiping){ const tx = Math.min(0, dx); li.style.transform=`translateX(${tx}px)`; li.style.opacity = 1 - Math.min(0.5, Math.abs(tx)/200); } };
  const onEnd = ()=>{ if(!active) return; li.style.transition=''; if(swiping && dx < -60){
      const name=li.querySelector('label')?.textContent.trim()||'el producto';
      confirmUI(`¬øEliminar ‚Äú${name}‚Äù?`, ()=>{ li.remove(); updateAll(); saveState(); haptics(30); });
    }else{ li.style.transform=''; li.style.opacity=''; } active=false; swiping=false; dx=0; };
  li.addEventListener('dblclick', ()=>{ const chk=qS('.check', li); if(!chk) return; chk.checked=!chk.checked; li.classList.toggle('checked', chk.checked); updateAll(); saveState(); haptics(15); }, {passive:true});
  li.addEventListener('touchend', ()=>{ if(tapTimer){ clearTimeout(tapTimer); tapTimer=null; const chk=qS('.check', li); if(!chk) return; chk.checked=!chk.checked; li.classList.toggle('checked', chk.checked); updateAll(); saveState(); haptics(15); } else { tapTimer=setTimeout(()=>{ tapTimer=null; }, 250); }});
  li.addEventListener('touchstart', onStart, {passive:true}); li.addEventListener('touchmove', onMove, {passive:false}); li.addEventListener('touchend', onEnd, {passive:true}); li.addEventListener('touchcancel', onEnd, {passive:true});
}

/* ====== C√°lculos ====== */
function updateAll(){
  const bar = qS('#barra-progreso');
  let totalChecks=0, checked=0, totalQty=0, totalMoney=0;
  const perCat={higiene:0,limpieza:0,alimentos:0,conservas:0,otros:0};
  const subs=[];
  qSA('.card').forEach(card=>{
    const cat=getCat(card);
    const checks=qSA('.item .check', card);
    let cInCard=0;
    checks.forEach(chk=>{
      totalChecks++;
      const li=chk.closest('.item');
      const q=Number(qS('input.cant', li)?.value)||0;
      const p=Number(qS('input.precio', li)?.value)||0;
      const s=q*p;
      if(s>0) subs.push({li, sub:s});
      if(chk.checked){ cInCard++; totalQty+=q; totalMoney+=s; perCat[cat]+=s; }
    });
    const cont=qS('.contador', card); if(cont) cont.textContent=`(${cInCard}/${checks.length})`;
  });
  checked=qSA('.item .check:checked').length;
  const pct= totalChecks? Math.round((checked/totalChecks)*100):0;
  bar.style.width=pct+'%'; bar.textContent= pct===100? 'üéâ Completado!' : (pct+'%');

  qS('#total-seleccionados').textContent=checked; qS('#total-cantidad').textContent=totalQty; qS('#total-dinero').textContent=money(totalMoney);
  qS('#bb-sel').textContent = String(checked); qS('#bb-total').textContent = (Number(totalMoney).toLocaleString('es-MX',{minimumFractionDigits:2, maximumFractionDigits:2}));
  qSA('.total-cat').forEach(span=>{ const k=span.getAttribute('data-cat'); span.textContent=money(perCat[k]||0); });

  const maxSub=Math.max(0, ...subs.map(s=>s.sub)); const thr=maxSub*0.9;
  qSA('.item').forEach(li=>li.classList.remove('expensive')); if(maxSub>0){ subs.forEach(({li,sub})=>{ if(sub>=thr) li.classList.add('expensive'); }); }

  qSA('.item').forEach(li=>{ const q=Number(qS('input.cant',li)?.value)||0; const p=Number(qS('input.precio',li)?.value)||0; const s=q*p; const sub=qS('.subtotal', li); if(sub) sub.textContent=money(s); });

  applyViewFilter(currentView, currentSearch);
}

/* ====== Orden ====== */
function sortList(ul, mode){
  const items=qSA(':scope > .item', ul);
  const name=li=> (li.querySelector('label')?.textContent||'').trim().toLowerCase();
  const costo=li=> Number(qS('.precio', li)?.value)||0;
  const sub= li=> (Number(qS('input.cant', li)?.value)||0)*(Number(qS('.precio', li)?.value)||0);
  const checked=li=> qS('.check', li)?.checked?1:0;

  let arr=[...items];
  switch(mode){
    case 'nombre': arr.sort((a,b)=>name(a).localeCompare(name(b))); break;
    case 'costo' : arr.sort((a,b)=>costo(a)-costo(b)); break;
    case 'subtotal': arr.sort((a,b)=>sub(a)-sub(b)); break;
    case 'checked': arr.sort((a,b)=>checked(b)-checked(a)); break;
    default: return;
  }
  arr.forEach(li=>ul.appendChild(li));
}

/* ====== Confirm UI ====== */
function confirmUI(text, onYes){
  const ov=document.createElement('div'); ov.className='overlay';
  ov.innerHTML=`<div class="confirm" role="dialog" aria-modal="true"><p>${text}</p><div class="row"><button class="cbtn y">S√≠</button><button class="cbtn n">No</button></div></div>`;
  document.body.appendChild(ov);
  qS('.cbtn.y', ov).addEventListener('click', ()=>{ onYes?.(); ov.remove(); });
  qS('.cbtn.n', ov).addEventListener('click', ()=>ov.remove());
}

/* ====== Acordeones (persistencia) ====== */
function setCollapsed(card, collapsed){
  const items = qS('.items', card); const btn = qS('.toggle', card);
  if(!items || !btn) return;
  items.classList.toggle('collapsed', collapsed); card.classList.toggle('collapsed', collapsed);
  btn.setAttribute('aria-expanded', String(!collapsed));
  const ui = readUI(); ui.accordions = ui.accordions || {}; ui.accordions[getCat(card)] = !!collapsed; writeUI(ui);
}
function collapseAll(v){ qSA('.card').forEach(card=> setCollapsed(card, v)); }

/* ====== Filtros / b√∫squeda / vista ====== */
function filterTerm(term){ currentSearch=(term||'').toLowerCase(); applyViewFilter(currentView, currentSearch); }
function applyViewFilter(view='todos', term=''){
  currentView=view;
  const showByView = (li)=>{
    const isMarked = qS('.check', li)?.checked;
    const isFav = li.classList.contains('fav-on');
    if(view==='pendientes') return !isMarked;
    if(view==='marcados') return !!isMarked;
    if(view==='favoritos') return !!isFav;
    return true;
  };
  qSA('.card').forEach(card=>{
    let showCard=false;
    qSA('.item', card).forEach(li=>{
      const txt=li.innerText.toLowerCase();
      const bySearch = !term || txt.includes(term);
      const visible = bySearch && showByView(li);
      li.style.display = visible? 'flex':'none';
      if(visible) showCard=true;
    });
    card.style.display = showCard? 'block':'none';
  });
  const ui = readUI(); ui.view = view; writeUI(ui);
  qSA('.seg-btn').forEach(b=> b.classList.toggle('active', b.dataset.view===view));
}

/* ====== PWA & SW ====== */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferredPrompt = e;
  const btn = qS('#btn-instalar'); btn.style.display = 'inline-flex';
  btn.onclick = async () => { btn.disabled = true; try{ deferredPrompt.prompt(); await deferredPrompt.userChoice; }finally{ deferredPrompt = null; btn.style.display = 'none'; } };
});
function showUpdateBanner(waitingSW){
  const banner = qS('#update-banner'); banner.style.display = 'flex';
  qS('#btn-update').onclick = ()=> waitingSW.postMessage({type:'SKIP_WAITING'});
  qS('#btn-update-cancel').onclick = ()=> banner.style.display='none';
}
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').then(reg=>{
      if(reg.waiting) showUpdateBanner(reg.waiting);
      reg.addEventListener('updatefound', ()=>{ const sw = reg.installing; if(!sw) return; sw.addEventListener('statechange', ()=>{ if(sw.state === 'installed' && reg.waiting){ showUpdateBanner(reg.waiting); } });});
      navigator.serviceWorker.addEventListener('controllerchange', ()=> window.location.reload());
    }).catch(()=>{});
  });
}

/* ====== Export / Import (QR) ====== */
/* --- LZ-String (MIT) minificado: compresi√≥n Base64 para payload QR --- */
!function(r){function t(r){switch(o){case 0:return r<<1;case 1:return r<<1|1;case 2:return r<<1|2}}function e(e){for(var n="",i=0;i<e.length;i+=2){var a=parseInt(e.substring(i,i+2),16);n+=String.fromCharCode(a)}return n}var n=String.fromCharCode,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o=0,a={compressToBase64:function(r){if(null==r)return"";var t=a._compress(r,6,function(r){return i.charAt(r)});switch(t.length%4){default:case 0:return t;case 1:return t+"===";case 2:return t+"==";case 3:return t+"="}},decompressFromBase64:function(r){return null==r?"":""==r?null:a._decompress(r.length,32,function(t){return function(r){return i.indexOf(r.charAt(t++))}(t)})},_compress:function(r,i,o){if(null==r)return"";var a,s,u,c={},f={},l="",h="",v="",d=2,g=3,p=2,m=[],b=0,y=0;for(s=0;s<r.length;s+=1)if(l=r.charAt(s),Object.prototype.hasOwnProperty.call(c,l)||(c[l]=g++,f[l]=!0),h=v+l,Object.prototype.hasOwnProperty.call(c,h))v=h;else{if(Object.prototype.hasOwnProperty.call(f,v)){if(v.charCodeAt(0)<256){for(a=0;a<p;a++)b<<=1,y==i-1?(y=0,m.push(o(b)),b=0):y++;for(u=v.charCodeAt(0),a=0;a<8;a++)b=b<<1|1&u,y==i-1?(y=0,m.push(o(b)),b=0):y++,u>>=1}else{for(u=1,a=0;a<p;a++)b=b<<1|u,y==i-1?(y=0,m.push(o(b)),b=0):y++,u=0;for(u=v.charCodeAt(0),a=0;a<16;a++)b=b<<1|1&u,y==i-1?(y=0,m.push(o(b)),b=0):y++,u>>=1}d--,0==d&&(d=Math.pow(2,p),p++),c[v]=g++,v=String(v.charAt(0)),d--,0==d&&(d=Math.pow(2,p),p++)}else for(u=c[v],a=0;a<p;a++)b=b<<1|1&u,y==i-1?(y=0,m.push(o(b)),b=0):y++,u>>=1;d--,0==d&&(d=Math.pow(2,p),p++),c[h]=g++,v=String(l)}if(""!==v){if(Object.prototype.hasOwnProperty.call(f,v)){if(v.charCodeAt(0)<256){for(a=0;a<p;a++)b<<=1,y==i-1?(y=0,m.push(o(b)),b=0):y++;for(u=v.charCodeAt(0),a=0;a<8;a++)b=b<<1|1&u,y==i-1?(y=0,m.push(o(b)),b=0):y++,u>>=1}else{for(u=1,a=0;a<p;a++)b=b<<1|u,y==i-1?(y=0,m.push(o(b)),b=0):y++,u=0;for(u=v.charCodeAt(0),a=0;a<16;a++)b=b<<1|1&u,y==i-1?(y=0,m.push(o(b)),b=0):y++,u>>=1}d--,0==d&&(d=Math.pow(2,p),p++)}else for(u=c[v],a=0;a<p;a++)b=b<<1|1&u,y==i-1?(y=0,m.push(o(b)),b=0):y++,u>>=1;d--,0==d&&(d=Math.pow(2,p),p++)}for(u=2,a=0;a<p;a++)b=b<<1|u,y==i-1?(y=0,m.push(o(b)),b=0):y++,u=0;for(;;){if(b<<=1,y==i-1){m.push(o(b));break}y++}return m.join("")},_decompress:function(r,t,e){var i,o,a,s,u,c,f,l=[],h=4,v=4,d=3,g="",p=[],m={val:e(0),position:t,index:1};for(i=0;i<3;i+=1)l[i]=i;for(o=0,c=Math.pow(2,2),a=1;a!=c;)s=m.val&m.position,m.position>>=1,0==m.position&&(m.position=t,m.val=e(m.index++)),o|=(s>0?1:0)*a,a<<=1;switch(i=o){case 0:for(o=0,c=Math.pow(2,8),a=1;a!=c;)s=m.val&m.position,m.position>>=1,0==m.position&&(m.position=t,m.val=e(m.index++)),o|=(s>0?1:0)*a,a<<=1;f=n(o);break;case 1:for(o=0,c=Math.pow(2,16),a=1;a!=c;)s=m.val&m.position,m.position>>=1,0==m.position&&(m.position=t,m.val=e(m.index++)),o|=(s>0?1:0)*a,a<<=1;f=n(o);break;case 2:return""}for(l[3]=f,u=f,p.push(f);;){if(m.index>r)return"";for(o=0,c=Math.pow(2,d),a=1;a!=c;)s=m.val&m.position,m.position>>=1,0==m.position&&(m.position=t,m.val=e(m.index++)),o|=(s>0?1:0)*a,a<<=1;switch(f=o){case 0:for(o=0,c=Math.pow(2,8),a=1;a!=c;)s=m.val&m.position,m.position>>=1,0==m.position&&(m.position=t,m.val=e(m.index++)),o|=(s>0?1:0)*a,a<<=1;l[v++]=n(o),f=v-1,h--;break;case 1:for(o=0,c=Math.pow(2,16),a=1;a!=c;)s=m.val&m.position,m.position>>=1,0==m.position&&(m.position=t,m.val=e(m.index++)),o|=(s>0?1:0)*a,a<<=1;l[v++]=n(o),f=v-1,h--;break;case 2:return p.join("")}if(0==h&&(h=Math.pow(2,d),d++),l[f])g=l[f];else{if(f!==v)return null;g=u+u.charAt(0)}p.push(g),l[v++]=u+g.charAt(0),h--,u=g,0==h&&(h=Math.pow(2,d),d++)}}};"function"==typeof define&&define.amd?define(function(){return a}):"object"==typeof module&&module.exports?module.exports=a:r.LZString=a}("undefined"!=typeof window?window:this);

/* --- QRCode minimal (MIT) de Kazuhiko Arase ‚Äì versi√≥n reducida para canvas --- */
/* Nota: Solo usamos generaci√≥n (no versi√≥n MicroQR). */
(function(){function l(a,b){this._el=a;this._htOption=b}function u(a){this.mode=n.MODE_8BIT_BYTE;this.data=a}function q(a,b){this.typeNumber=a;this.errorCorrectLevel=b;this.modules=null;this.moduleCount=0;this.dataList=[]}var n={PAD0:236,PAD1:17,MODE_8BIT_BYTE:4,ErrorCorrectLevel:{L:1,M:0,Q:3,H:2}},t=function(){var a=[[]];return{getRSFactor:function(b){return a[b]},init:function(){function b(b,e){for(var c=Array(b),d=0;d<b;d++)c[d]=Array(b);return{addPoly:function(b){for(var d=0;d<b.length;d++)c[0][d]=b[d]},getAt:function(b,d){return c[b][d]}}}a[7]=b(7);a[10]=b(10);a[13]=b(13);a[15]=b(15)}}}();t.init();u.prototype={getLength:function(){return this.data.length},write:function(a){for(var b=0;b<this.data.length;b++){var e=this.data.charCodeAt(b);a.put(e,8)}}};q.prototype={addData:function(a){this.dataList.push(new u(a))},isDark:function(a,b){if(null==this.modules[a]||null==this.modules[a][b])throw Error(a+","+b);return this.modules[a][b]},getModuleCount:function(){return this.moduleCount},make:function(){var a=this.typeNumber;for(a=1;40>=a;a++){this.typeNumber=a;if(this._tryMake()){return}}},_tryMake:function(){this.moduleCount=4*this.typeNumber+17;this.modules=Array(this.moduleCount);for(var a=0;a<this.moduleCount;a++){this.modules[a]=Array(this.moduleCount);for(var b=0;b<this.moduleCount;b++)this.modules[a][b]=null}this._setupPosPattern(0,0);this._setupPosPattern(this.moduleCount-7,0);this._setupPosPattern(0,this.moduleCount-7);for(var a=8,b=this.moduleCount-8; a<=b; a++)null==this.modules[a][6]&&(this.modules[a][6]=0==a%2);for(a=8,b=this.moduleCount-8; a<=b; a++)null==this.modules[6][a]&&(this.modules[6][a]=0==a%2);this._mapData(this._createData());return!0},_setupPosPattern:function(a,b){for(var e= -1;7>=e;e++)if(!(0>a+e||this.moduleCount<=a+e))for(var c=-1;7>=c;c++)0>b+c||this.moduleCount<=b+c||(this.modules[a+e][b+c]=0<=e&&6>=e&&0<=c&&6>=c&&(0==e||6==e||0==c||6==c||2<=e&&4>=e&&2<=c&&4>=c)?!0:!1)},_createData:function(){for(var a=[],b=0;b<this.dataList.length;b++){var e=this.dataList[b];a.push(4);a.push(e.getLength());for(var c=0;c<e.data.length;c++)a.push(e.data.charCodeAt(c))}a.push(0);return a},_mapData:function(a){for(var b=0,e=this.moduleCount-1,c=this.moduleCount-1,d=0,g=!0;0<c;c-=2){6==c&&c--;for(;;){for(var f=0;2>f;f++)null==this.modules[e][c-f]&&(0<d?a[d--]&1?this.modules[e][c-f]=!0:this.modules[e][c-f]=!1:this.modules[e][c-f]=!1);e+=g?-1:1;if(e<0||this.moduleCount<=e){e+=g?1:-1;g=!g;break}}}},createCanvas:function(a){var b=this.getModuleCount(),e=a.size||320,c=a.marginModules||4,d=a.dark||"#000",g=a.light||"#fff",f=a.scale||Math.floor((e-2*c)/b);e=f*b+2*c;var h=a.canvas||document.createElement("canvas");h.width=e;h.height=e;var k=h.getContext("2d");k.fillStyle=g;k.fillRect(0,0,e,e);k.fillStyle=d;for(var m=0;m<b;m++)for(var p=0;p<b;p++)this.isDark(m,p)&&k.fillRect(c+f*m,c+f*p,f,f);return h}};l.prototype={makeCode:function(a){this._oQRCode=new q(1,n.ErrorCorrectLevel.H);this._oQRCode.addData(a);this._oQRCode.make()},createCanvas:function(a){return this._oQRCode.createCanvas(a)}};window._SimpleQR=l;})();

/* Payload helpers */
function buildExportObject(){
  const ls = readState();
  const ui = readUI();
  return { v:7, ts: Date.now(), ls, ui };
}
function encodeExportPayload(obj){
  const json = JSON.stringify(obj);
  const packed = LZString.compressToBase64(json);
  return `PDV7:${packed}`;
}
function decodeImportPayload(text){
  try{
    if(!/^PDV\d+:/.test(text)) throw new Error('Formato desconocido');
    const [,ver,base]=text.match(/^PDV(\d+):(.*)$/) || [];
    if(!base) throw new Error('Sin datos');
    const json = LZString.decompressFromBase64(base);
    if(!json) throw new Error('No se pudo descomprimir');
    const obj = JSON.parse(json);
    if(!obj || typeof obj!=='object') throw new Error('JSON inv√°lido');
    if(!Array.isArray(obj.ls)) throw new Error('Lista inv√°lida');
    return { ver: Number(ver), data: obj };
  }catch(e){ throw e; }
}

/* Generar QR en modal */
function openExportQR(){
  try{ saveState(); }catch{}
  const payload = encodeExportPayload(buildExportObject());
  const ov = qS('#qr-overlay'); ov.style.display='flex';
  const qr = new _SimpleQR(null,{});
  qr.makeCode(payload);
  const canvas = qr.createCanvas({
    size: 800,           // Grande
    marginModules: 4,    // Quiet zone amplia
    scale: 8,            // m√≥dulos peque√±os pero legibles
    dark: '#000',
    light: '#fff',
    canvas: qS('#qr-canvas')
  });
  // Accesibilidad: texto alterno con parte del payload (no completo por largo)
  canvas.setAttribute('aria-label', 'QR de exportaci√≥n de lista');
  qS('#qr-close').onclick = ()=>{ ov.style.display='none'; };
  ov.addEventListener('click', (e)=>{ if(e.target===ov) ov.style.display='none'; });
}

/* Importar: escaneo QR y sobrescribir LS/UI */
let importStream=null, importRAF=null, importDetector=null;
async function openImportScanner(){
  const overlay = qS('#import-overlay'); const video = qS('#import-video');
  if(!('BarcodeDetector' in window)){ alert('Esc√°ner no soportado en este navegador. Usa Chrome/Android o copia los datos manualmente.'); return; }
  overlay.style.display='flex';
  try{
    importDetector = new BarcodeDetector({formats:['qr_code']});
    importStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = importStream; await video.play();
    const tick = async ()=>{
      try{
        const codes = await importDetector.detect(video);
        if(codes && codes.length){
          const code = codes[0].rawValue || '';
          if(/^PDV\d+:/.test(code)){
            stopImportScanner();
            try{
              const { data } = decodeImportPayload(code);
              const total = Array.isArray(data.ls)? data.ls.length : 0;
              confirmUI(`Se importar√° una lista con ${total} elemento(s) y se sobrescribir√° tu estado actual. ¬øContinuar?`, ()=>{
                try{
                  localStorage.setItem(LS_KEY, JSON.stringify(migrateState(data.ls)));
                  localStorage.setItem(UI_KEY, JSON.stringify(data.ui||{}));
                }catch{}
                window.location.reload();
              });
            }catch(err){
              alert('QR le√≠do, pero no es un paquete v√°lido de exportaci√≥n: '+ err.message);
            }
            return;
          }
        }
      }catch{}
      importRAF = requestAnimationFrame(tick);
    };
    importRAF = requestAnimationFrame(tick);
  }catch(e){ alert('No fue posible abrir la c√°mara.'); closeImportScanner(); }
  qS('#import-cancel').onclick = closeImportScanner;
  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeImportScanner(); });
}
function stopImportScanner(){
  if(importRAF) cancelAnimationFrame(importRAF); importRAF=null;
  if(importStream){ importStream.getTracks().forEach(t=>t.stop()); importStream=null; }
  qS('#import-overlay').style.display='none';
}
function closeImportScanner(){ stopImportScanner(); }

/* ====== Inicializaci√≥n ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Preparar base
  qSA('.items').forEach(ul=> qSA('.item', ul).forEach(ensureControls));

  // Estado
  let state = loadState(); state = migrateState(state || []); rebuildFromState(state); applyState(state);

  // UI guardada
  const ui = readUI();
  if(ui.accordions){ qSA('.card').forEach(card=>{ const cat=getCat(card); if(cat in ui.accordions) setCollapsed(card, !!ui.accordions[cat]); }); }
  if(ui.sort){ qSA('.card').forEach(card=>{ const cat=getCat(card); const sel = qS('.sort', card); if(sel && ui.sort[cat]){ sel.value = ui.sort[cat]; const ul = qS('.items', card); sortList(ul, sel.value); } }); }
  applyViewFilter(ui.view || 'todos', '');

  // B√∫squeda
  const searchTop=qS('#busqueda'); const sheet = qS('#search-sheet'); const sheetInput = qS('#busqueda-sheet');
  searchTop.addEventListener('input', ()=> filterTerm(searchTop.value));
  const openSheet = ()=>{ sheet.classList.add('open'); setTimeout(()=>sheetInput.focus(), 50); };
  const closeSheet = ()=>{ sheet.classList.remove('open'); sheetInput.value=''; filterTerm(''); };
  qS('#fab-search').addEventListener('click', openSheet); qS('#sheet-close').addEventListener('click', closeSheet);
  sheetInput.addEventListener('input', ()=> filterTerm(sheetInput.value));

  // Orden por categor√≠a (+ persistencia)
  qSA('.card .sort').forEach(sel=>{
    sel.addEventListener('change', ()=>{
      const ul= sel.closest('.card').querySelector('.items'); sortList(ul, sel.value);
      const card = sel.closest('.card'); const cat = getCat(card);
      const ui = readUI(); ui.sort = ui.sort || {}; ui.sort[cat] = sel.value; writeUI(ui); saveState();
    });
  });

  // Acorde√≥n por tarjeta
  qSA('.card').forEach(card=>{
    const btn = qS('.toggle', card);
    if(btn){ btn.addEventListener('click', ()=>{ const collapsed = btn.getAttribute('aria-expanded')!=='false'; setCollapsed(card, collapsed); }); }
  });

  // Expand/Collapse (top + FABs)
  qS('#btn-expandir').addEventListener('click', ()=> collapseAll(false));
  qS('#btn-colapsar').addEventListener('click', ()=> collapseAll(true));
  qS('#fab-expand').addEventListener('click', ()=> collapseAll(false));
  qS('#fab-collapse').addEventListener('click', ()=> collapseAll(true));

  // Speed dial toggle + acciones
  const speed = qS('#fab-speed'); qS('#fab-more').addEventListener('click', ()=> speed.classList.toggle('open'));
  qS('#fab-share').addEventListener('click', shareResumen); qS('#fab-print').addEventListener('click', printResumen);
  qS('#fab-favs').addEventListener('click', ()=> applyViewFilter('favoritos'));
  qS('#fab-scan').addEventListener('click', openScanner);
  qS('#fab-export').addEventListener('click', openExportQR);
  qS('#fab-import').addEventListener('click', openImportScanner);

  // Segmentado vista
  qS('#view-todos').addEventListener('click', ()=> applyViewFilter('todos', currentSearch));
  qS('#view-pend').addEventListener('click', ()=> applyViewFilter('pendientes', currentSearch));
  qS('#view-mark').addEventListener('click', ()=> applyViewFilter('marcados', currentSearch));
  qS('#view-fav').addEventListener('click', ()=> applyViewFilter('favoritos', currentSearch));

  // Compartir / Imprimir / Export / Import
  qS('#btn-compartir').addEventListener('click', shareResumen);
  qS('#btn-compartir-bottom').addEventListener('click', shareResumen);
  qS('#btn-imprimir').addEventListener('click', printResumen);
  qS('#btn-imprimir-bottom').addEventListener('click', printResumen);
  qS('#btn-exportar').addEventListener('click', openExportQR);
  qS('#btn-exportar-bottom').addEventListener('click', openExportQR);
  qS('#btn-importar').addEventListener('click', openImportScanner);
  qS('#btn-importar-bottom').addEventListener('click', openImportScanner);
  qS('#qr-close').addEventListener('click', ()=> qS('#qr-overlay').style.display='none');

  // Agregar (admin y FAB)
  qS('#agregar-producto').addEventListener('click', ()=> openModalNuevo());
  qS('#fab-add').addEventListener('click', ()=> openModalNuevo());

  // Mic (voz) en top y sheet
  qS('#btn-mic-top').addEventListener('click', ()=> startVoice());
  qS('#btn-mic-sheet').addEventListener('click', ()=> startVoice(true));

  // Onboarding
  runOnboardingOnce();

  updateAll(); saveState();
});

/* ====== Scanner (BarcodeDetector) existente para agregar productos ====== */
let scanStream=null, scanRAF=null, detector=null;
async function openScanner(){
  const overlay = qS('#scan-overlay'); const video = qS('#scan-video');
  if(!('BarcodeDetector' in window)){ alert('Esc√°ner no soportado en este navegador.'); return; }
  overlay.style.display='flex';
  try{
    detector = new BarcodeDetector({formats:['ean_13','ean_8','code_128','qr_code','upc_a','upc_e']});
    scanStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    video.srcObject = scanStream; await video.play();
    const tick = async ()=>{
      try{
        const codes = await detector.detect(video);
        if(codes && codes.length){
          stopScanner();
          const code = codes[0].rawValue || '';
          openModalNuevo({nombre: code, cantidad:1, precio:''});
          return;
        }
      }catch{}
      scanRAF = requestAnimationFrame(tick);
    };
    scanRAF = requestAnimationFrame(tick);
  }catch(e){ alert('No fue posible abrir la c√°mara.'); closeScanner(); }
  qS('#scan-cancel').onclick = closeScanner;
  overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeScanner(); });
}
function stopScanner(){
  if(scanRAF) cancelAnimationFrame(scanRAF); scanRAF=null;
  if(scanStream){ scanStream.getTracks().forEach(t=>t.stop()); scanStream=null; }
  qS('#scan-overlay').style.display='none';
}
function closeScanner(){ stopScanner(); }

/* ====== Voz (SpeechRecognition) ====== */
function wordsToNumber(w){
  w = (w||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').trim();
  const dict = {
    'un':1,'uno':1,'una':1,'dos':2,'tres':3,'cuatro':4,'cinco':5,'seis':6,'siete':7,'ocho':8,'nueve':9,'diez':10,
    'once':11,'doce':12,'trece':13,'catorce':14,'quince':15,'dieciseis':16,'diecisiete':17,'dieciocho':18,'diecinueve':19,
    'veinte':20,'veintiuno':21,'veintidos':22,'veintitres':23,'veinticuatro':24,'veinticinco':25,'veintiseis':26,'veintisiete':27,'veintiocho':28,'veintinueve':29,
    'treinta':30,'cuarenta':40,'cincuenta':50
  };
  if(/^\d+([.,]\d+)?$/.test(w)) return Number(w.replace(',','.'));
  if(w in dict) return dict[w];
  return NaN;
}
function parseVoiceCommand(txt){
  const t = txt.toLowerCase().trim();
  const m = t.match(/^agrega\s+(.+)\s+a\s+([0-9]+(?:[.,][0-9]+)?)(?:\s*(?:mxn|pesos?))?$/i);
  if(!m) return null;
  const parts = m[1].trim().split(/\s+/);
  if(!parts.length) return null;
  const cantWord = parts.shift();
  const cantidad = wordsToNumber(cantWord);
  if(!isFinite(cantidad)) return null;
  const producto = [ ...parts ].join(' ').trim();
  if(!producto) return null;
  const precio = Number(m[2].replace(',','.'));
  if(!isFinite(precio)) return null;
  return {cantidad, nombre: producto, precio};
}
function startVoice(fromSheet=false){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert('Reconocimiento de voz no disponible.'); return; }
  const rec = new SR(); rec.lang='es-MX'; rec.interimResults=false; rec.maxAlternatives=1;
  rec.onresult = (e)=>{
    const txt = e.results[0][0].transcript || '';
    const parsed = parseVoiceCommand(txt);
    if(parsed){ openModalNuevo({nombre: parsed.nombre, cantidad: parsed.cantidad, precio: parsed.precio, categoria: guessCategory(parsed.nombre)}); }
    else{ alert('Di exactamente: "Agrega {cantidad} {producto} a {precio}"\nEjemplo: "Agrega dos salsa de tomate a 91"'); }
  };
  rec.onerror = ()=>{};
  rec.start();
}

/* ====== Onboarding ====== */
function runOnboardingOnce(){
  try{
    const ui = readUI();
    if(ui.onboarded) return;
    const steps = [
      {el: '#fab-add', text: 'Toca aqu√≠ para *agregar* un producto r√°pido.', btn:'Siguiente'},
      {el: '.item .check', text: 'Marca/desmarca productos con un toque. *Doble tap* o desliza para eliminar.', btn:'Siguiente'},
      {el: '#fab-share', text: 'Comparte por WhatsApp/Telegram un resumen ordenado.', btn:'Listo'}
    ];
    let i=0;
    const show = ()=>{
      const s=steps[i]; if(!s) { const ui=readUI(); ui.onboarded=true; writeUI(ui); return; }
      const rect = qS(s.el).getBoundingClientRect();
      const tip = document.createElement('div'); tip.className='tip'; tip.innerHTML = `<div>${s.text}</div><div class="actions"><button class="btn">${s.btn}</button><button class="btn btn-outline">Omitir</button></div>`;
      document.body.appendChild(tip);
      const top = Math.max(12, rect.top - tip.offsetHeight - 10);
      const left = Math.min(window.innerWidth - tip.offsetWidth - 12, rect.left);
      tip.style.top = `${top}px`; tip.style.left = `${left}px`;
      tip.querySelector('.btn').onclick = ()=>{ tip.remove(); i++; show(); };
      tip.querySelector('.btn-outline').onclick = ()=>{ tip.remove(); const ui=readUI(); ui.onboarded=true; writeUI(ui); };
    };
    setTimeout(show, 500);
  }catch{}
}

/* ====== B√∫squeda flotante: abrir/cerrar desde teclado ESC ====== */
document.addEventListener('keydown', (e)=>{ if(e.key==='/' && !e.metaKey && !e.ctrlKey){ e.preventDefault(); qS('#busqueda').focus(); } });

/* ====== Resto: compartir e imprimir ====== */
const CAT_ICON = {higiene:'üßº', limpieza:'üßΩ', alimentos:'üçö', conservas:'ü•´', otros:'üß∞'};
function pad(str, len){ str=String(str||''); if(str.length>len) return str.slice(0, len-1)+'‚Ä¶'; while(str.length<len) str+=' '; return str; }
function buildResumenTexto(){
  const selected=qSA('.item .check:checked').map(c=>c.closest('.item'));
  const order=['higiene','limpieza','alimentos','conservas','otros'];
  const groups={higiene:[], limpieza:[], alimentos:[], conservas:[], otros:[]};
  let grand=0;

  selected.forEach(li=>{ const card=li.closest('.card'); const cat=getCat(card)||'otros'; groups[cat].push(li); });

  let out = `*Primera Despensa* ¬∑ ${new Date().toLocaleString('es-MX')}\n`;
  out += '```' + '\n';
  order.forEach(cat=>{
    const lis = groups[cat]; if(!lis || !lis.length) return;
    let tot=0; out += `${(CAT_ICON[cat]||'‚Ä¢')} ${cat.toUpperCase()}\n`;
    out += `  ${pad('Producto',24)} ${pad('Cant',4)} ${pad('Precio',10)} ${pad('Subtotal',12)}\n`;
    out += `  ${'-'.repeat(24)} ${'-'.repeat(4)} ${'-'.repeat(10)} ${'-'.repeat(12)}\n`;
    lis.forEach(li=>{
      const name=li.querySelector('label')?.textContent.trim()||''; const q=Number(qS('input.cant',li)?.value)||0; const p=Number(qS('.precio',li)?.value)||0; const s=q*p; tot+=s;
      out += `  ${pad(name,24)} ${pad(q,4)} ${pad(p.toFixed(2),10)} ${pad(s.toFixed(2),12)}\n`;
    });
    out += `  ${' '.repeat(24+4+10-6)}TOTAL: ${pad(tot.toFixed(2),12)}\n\n`;
    grand+=tot;
  });
  out += `TOTAL GENERAL: ${grand.toFixed(2)}\n`;
  out += '```' + '\n';
  out += '_Compartido desde ‚ÄúPrimera Despensa‚Äù_';
  return out;
}
async function shareResumen(){
  const texto = buildResumenTexto();
  if(navigator.share){ try{ await navigator.share({ text: texto }); return; }catch(e){} }
  const enc = encodeURIComponent(texto);
  const wa = `https://wa.me/?text=${enc}`;
  const tg = `https://t.me/share/url?text=${enc}`;
  window.open(wa, '_blank'); setTimeout(()=>window.open(tg, '_blank'), 300);
}
function printResumen(){
  const selected=qSA('.item .check:checked').map(c=>c.closest('.item'));
  if(!selected.length){ alert('No hay productos seleccionados.'); return; }
  const size = (prompt('Formato de papel: escribe A4 o A5', 'A4')||'A4').toUpperCase()==='A5'?'A5':'A4';

  const order=['higiene','limpieza','alimentos','conservas','otros']; const groups={}; let grand=0, totalSel=selected.length;
  selected.forEach(li=>{ const card=li.closest('.card'); const cat=getCat(card)||'otros'; (groups[cat]??=[]).push(li); });

  const w=window.open('','_blank');
  const css=`@page { size:${size}; margin:14mm }
  body{font-family:Segoe UI,Arial,sans-serif;color:#111;font-size:12px}
  .head{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e5e7eb;padding-bottom:6px;margin-bottom:10px}
  .brand{font-weight:800;font-size:16px}
  .meta{color:#374151}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0 10px}
  .chip{border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;display:inline-block;background:#fff}
  h2{margin:12px 0 6px;font-size:13px;border-bottom:1px solid #e5e7eb;padding-bottom:4px}
  table{width:100%;border-collapse:collapse;margin-bottom:8px}
  th,td{border:1px solid #e5e7eb;padding:6px 8px;text-align:left}
  th{background:#f8fafc}
  tfoot td{font-weight:700}
  .tot{font-size:14px;font-weight:800;margin-top:12px}
  .footer{margin-top:14px;color:#6b7280;font-size:11px}`;
  let html=`<html><head><meta charset="UTF-8"><title>Resumen de compra</title><style>${css}</style></head><body>`;
  const shareText = buildResumenTexto();
  const qr = encodeExportPayload(buildExportObject()); // QR con payload para imprimir
  html+=`<div class="head"><div class="brand">üõçÔ∏è Primera Despensa</div><div class="meta">${new Date().toLocaleString('es-MX')}</div><div><img alt="QR" src="${makeQRDataURL(qr,120)}" width="90" height="90"></div></div>`;
  html+=`<div class="grid"><div class="chip">Marcados: <b>${totalSel}</b></div><div class="chip">Formato: ${size}</div></div>`;

  order.forEach(cat=>{
    const lis = groups[cat]; if(!lis || !lis.length) return; let tot=0;
    html+=`<h2>${cat.charAt(0).toUpperCase()+cat.slice(1)}</h2><table><thead><tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr></thead><tbody>`;
    lis.forEach(li=>{
      const name=li.querySelector('label')?.textContent.trim()||''; const q=Number(qS('input.cant',li)?.value)||0; const p=Number(qS('.precio',li)?.value)||0; const s=q*p; tot+=s;
      html+=`<tr><td>${name}</td><td>${q}</td><td>${money(p)}</td><td>${money(s)}</td></tr>`;
    });
    html+=`</tbody><tfoot><tr><td colspan="3">Total ${cat}</td><td>${money(tot)}</td></tr></tfoot></table>`; grand+=tot;
  });

  html+=`<div class="tot">TOTAL: ${money(grand)}</div><div class="footer">Documento optimizado para impresi√≥n. Precios en MXN. Incluye QR para importar en otro dispositivo.</div>`;
  html+=`</body></html>`;
  w.document.write(html); w.document.close(); w.focus(); w.print();
}

/* Utilidad para crear un DataURL PNG del QR (para impresi√≥n) */
function makeQRDataURL(text, size=120){
  const gen = new _SimpleQR(null,{});
  gen.makeCode(text);
  const cnv = gen.createCanvas({ size: size, marginModules: 2, scale: 4, dark:'#000', light:'#fff' });
  return cnv.toDataURL('image/png');
}

/* ====== Borrar estado ====== */
qS('#btn-borrar').addEventListener('click', ()=>{
  confirmUI('¬øBorrar todo el estado guardado (checks, cantidades, costos, favoritos y UI)?', ()=>{
    localStorage.removeItem(LS_KEY); localStorage.removeItem(UI_KEY); window.location.reload();
  });
});
</script>
</body>
</html>
