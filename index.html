<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lista de Primera Despensa - Mejorada</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f4f4f9;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
    }

    .canva-container {
        max-width: 1100px;
        width: 100%;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
    }

    h1 {
        grid-column: 1/-1;
        text-align: center;
        color: #2c3e50;
        font-size: 2rem;
        margin-bottom: 16px;
    }

    .top-actions {
        grid-column: 1/-1;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        margin-bottom: .5rem;
    }
    .top-actions button,
    .top-actions input[type="text"] {
        padding: 10px 14px;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        background: #fff;
        font-weight: 600;
        cursor: pointer;
    }
    .top-actions button:hover { filter: brightness(0.97); }
    .btn-print { background: #111827; color: #fff; border-color: #111827; }
    .btn-clear { background: #ef4444; color: #fff; border-color: #ef4444; }

    .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        transition: transform 0.2s;
        overflow: hidden;
    }

    .card header {
        margin: 0;
        padding: 10px 12px;
        color: white;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        align-items: center;
    }
    .card header .left h2 {
        margin: 0;
        font-size: 1.06rem;
        display: flex;
        align-items: center;
        gap: .5rem;
    }
    .card header .contador {
        font-size: 0.8rem;
        background: rgba(255,255,255,0.3);
        padding: 2px 6px;
        border-radius: 12px;
    }
    .card header .right {
        display: flex;
        gap: 6px;
        align-items: center;
        justify-content: flex-end;
        flex-wrap: wrap;
    }
    .right select {
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid rgba(255,255,255,0.7);
        background: rgba(255,255,255,0.9);
        font-size: .85rem;
        min-width: 150px;
        cursor: pointer;
    }
    .right .total-cat {
        background: rgba(255,255,255,0.15);
        color: #fff;
        padding: 6px 10px;
        border-radius: 999px;
        font-weight: 700;
        font-size: .9rem;
        white-space: nowrap;
    }

    .card ul {
        list-style: none;
        padding: 10px 0 6px 0;
        margin: 0;
        flex: 1;
        max-height: 1000px;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    /* Colores por secci√≥n */
    .higiene header { background-color: #3498db; }
    .limpieza header { background-color: #27ae60; }
    .alimentos header { background-color: #f1c40f; color: #333; }
    .conservas header { background-color: #e67e22; }
    .otros header { background-color: #9b59b6; }

    li {
        background: #ecf0f1;
        margin: 6px 12px;
        padding: 10px 12px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background 0.25s, transform 0.2s, border 0.2s;
        flex-wrap: wrap;
        border: 1px solid transparent;
    }

    li.highlight { background: #ffeaa7 !important; }
    li.checked { background: #d7f5f5; transform: scale(1.01); }
    li.expensive { border-color: #ef4444; background: #fee2e2; } /* m√°s caro */

    li:hover { background: #dcdde1; }

    input[type="checkbox"] {
        transform: scale(1.2);
        cursor: pointer;
    }

    label {
        flex: 1 1 160px;
        cursor: pointer;
        min-width: 140px;
    }

    .pc-wrap {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1 1 auto;
        flex-wrap: wrap;
    }

    .pc-wrap input[type="number"] {
        width: 90px;
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        font-size: 0.9rem;
        background: #fff;
    }

    .pc-wrap .subtotal {
        min-width: 98px;
        font-weight: 700;
    }

    .pc-wrap .eliminar {
        background: transparent;
        border: none;
        font-size: 1.1rem;
        cursor: pointer;
    }

    #filtro {
        grid-column: 1/-1;
        display: flex;
        justify-content: center;
    }
    #filtro input {
        width: 100%;
        max-width: 460px;
        padding: 10px 15px;
        font-size: 1rem;
        border-radius: 25px;
        border: 1px solid #ccc;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        transition: box-shadow 0.3s;
    }
    #filtro input:focus {
        outline: none;
        box-shadow: 0 0 8px rgba(52,152,219,0.6);
        border-color: #3498db;
    }

    .progress-container {
        grid-column: 1/-1;
        margin: 10px 0 10px 0;
    }

    .progress-bar {
        width: 100%;
        background: #ecf0f1;
        border-radius: 25px;
        overflow: hidden;
        height: 25px;
        box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
    }
    .progress-bar-inner {
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, #74b9ff, #0984e3);
        text-align: center;
        color: white;
        line-height: 25px;
        font-weight: bold;
        transition: width 0.3s ease;
    }

    .totales {
        grid-column: 1/-1;
        display: grid;
        grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
        gap: 10px;
        margin-top: 10px;
    }
    .total-card {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        padding: 12px 14px;
        text-align: center;
    }
    .total-card h4 {
        margin: 0 0 6px;
        color: #334155;
        font-size: .95rem;
        font-weight: 600;
    }
    .total-card .val {
        font-size: 1.15rem;
        font-weight: 700;
        color: #111827;
    }

    .admin-panel {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        margin: 12px 0 30px 0;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
    }
    .admin-panel h3 {
        text-align: center;
        margin-bottom: 15px;
        color: #333;
    }
    .admin-panel .input-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin-bottom: 10px;
    }
    .admin-panel input[type="text"],
    .admin-panel select {
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        flex: 1 1 200px;
        min-width: 150px;
        font-size: 14px;
        background: #fff;
    }
    .admin-panel button {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
    }
    .admin-panel button:hover { background: #218838; }
    .admin-panel .nota {
        display: block;
        text-align: center;
        color: #666;
        font-size: 12px;
    }

    /* Overlay confirmaci√≥n */
    .overlay-confirm {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .confirm-box {
        background: #fff;
        padding: 20px 25px;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        text-align: center;
        max-width: 420px;
        width: 90%;
    }
    .confirm-box p { font-size: 16px; color: #333; margin-bottom: 20px; }
    .confirm-buttons { display: flex; justify-content: space-around; }
    .btn-confirm {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-confirm.yes { background: #dc3545; color: #fff; }
    .btn-confirm.no { background: #6c757d; color: #fff; }
    .btn-confirm:hover { transform: scale(1.05); }

    @media(max-width:600px){
        .canva-container { grid-template-columns: 1fr; }
        li { margin: 6px 8px; }
        #filtro input { max-width: 100%; }
        .right { justify-content: flex-start; }
    }
</style>
</head>
<body>

<div class="canva-container">
    <h1>Lista de Primera Despensa</h1>

    <div class="top-actions">
        <button class="btn-print" id="btn-imprimir">Resumen imprimible</button>
        <button class="btn-clear" id="btn-borrar">Borrar todo (estado)</button>
    </div>

    <div id="filtro">
        <input type="text" id="busqueda" placeholder="Buscar producto...">
    </div>

    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-bar-inner" id="barra-progreso">0%</div>
        </div>

        <!-- Totales globales -->
        <div class="totales">
            <div class="total-card">
                <h4>Productos seleccionados</h4>
                <div class="val" id="total-seleccionados">0</div>
            </div>
            <div class="total-card">
                <h4>Cantidad total</h4>
                <div class="val" id="total-cantidad">0</div>
            </div>
            <div class="total-card">
                <h4>Total $</h4>
                <div class="val" id="total-dinero">$0.00</div>
            </div>
        </div>

        <!-- Panel de administraci√≥n -->
        <div id="admin-panel" class="admin-panel">
            <h3>Agregar / Quitar productos</h3>
            <div class="input-group">
                <input type="text" id="nuevo-producto" placeholder="Nombre del producto">
                <select id="categoria-nueva">
                    <option value="higiene">Higiene Personal</option>
                    <option value="limpieza">Limpieza del Hogar</option>
                    <option value="alimentos">Alimentos B√°sicos</option>
                    <option value="conservas">Conservas</option>
                    <option value="otros">Otros</option>
                </select>
                <button id="agregar-producto">Agregar</button>
            </div>
            <small class="nota">Marca ‚úì para incluirlo en el c√°lculo. Captura Cantidad y Costo unitario. El subtotal se calcula solo. üóëÔ∏è elimina (pide confirmaci√≥n). Se guarda autom√°ticamente en tu navegador.</small>
        </div>
    </div>

    <!-- TARJETAS -->
    <div class="card higiene">
        <header>
            <div class="left"><h2>Higiene Personal <span class="contador"></span></h2></div>
            <div class="right">
                <select class="sort-select">
                    <option value="none">Ordenar‚Ä¶</option>
                    <option value="nombre">Nombre (A-Z)</option>
                    <option value="costo">Costo unitario (‚Üë)</option>
                    <option value="subtotal">Subtotal (‚Üë)</option>
                    <option value="checked">Marcados primero</option>
                </select>
                <span class="total-cat" data-cat="higiene">$0.00</span>
            </div>
        </header>
        <ul>
            <li><input type="checkbox" id="jabon"><label for="jabon">Jabon de tocador</label></li>
            <li><input type="checkbox" id="jabonliquido"><label for="jabonliquido">Jabon liquido para manos</label></li>
            <li><input type="checkbox" id="shampoo"><label for="shampoo">Shampoo</label></li>
            <li><input type="checkbox" id="pasta"><label for="pasta">Pasta dental</label></li>
            <li><input type="checkbox" id="cepillo"><label for="cepillo">Cepillo de dientes</label></li>
            <li><input type="checkbox" id="papel"><label for="papel">Papel higienico</label></li>
            <li><input type="checkbox" id="toallitas"><label for="toallitas">Toallitas humedas</label></li>
            <li><input type="checkbox" id="toallas"><label for="toallas">Toallas femeninas / tampones</label></li>
            <li><input type="checkbox" id="desodorante"><label for="desodorante">Desodorante</label></li>
            <li><input type="checkbox" id="gel"><label for="gel">Gel antibacterial</label></li>
        </ul>
    </div>

    <div class="card limpieza">
        <header>
            <div class="left"><h2>Limpieza del Hogar <span class="contador"></span></h2></div>
            <div class="right">
                <select class="sort-select">
                    <option value="none">Ordenar‚Ä¶</option>
                    <option value="nombre">Nombre (A-Z)</option>
                    <option value="costo">Costo unitario (‚Üë)</option>
                    <option value="subtotal">Subtotal (‚Üë)</option>
                    <option value="checked">Marcados primero</option>
                </select>
                <span class="total-cat" data-cat="limpieza">$0.00</span>
            </div>
        </header>
        <ul>
            <li><input type="checkbox" id="detergente"><label for="detergente">Detergente para ropa</label></li>
            <li><input type="checkbox" id="suavizante"><label for="suavizante">Suavizante de ropa</label></li>
            <li><input type="checkbox" id="cloro"><label for="cloro">Cloro / lejia</label></li>
            <li><input type="checkbox" id="limpiador"><label for="limpiador">Limpiador multiusos</label></li>
            <li><input type="checkbox" id="escoba"><label for="escoba">Escoba</label></li>
            <li><input type="checkbox" id="trapeador"><label for="trapeador">Trapeador</label></li>
            <li><input type="checkbox" id="basura"><label for="basura">Bolsas de basura</label></li>
            <li><input type="checkbox" id="esponja"><label for="esponja">Esponja / estropajo</label></li>
            <li><input type="checkbox" id="desinfectante"><label for="desinfectante">Desinfectante</label></li>
            <li><input type="checkbox" id="guantes"><label for="guantes">Guantes de limpieza</label></li>
            <li><input type="checkbox" id="limpia-vidrios"><label for="limpia-vidrios">Limpiavidrios</label></li>
        </ul>
    </div>

    <div class="card alimentos">
        <header>
            <div class="left"><h2>Alimentos B√°sicos <span class="contador"></span></h2></div>
            <div class="right">
                <select class="sort-select">
                    <option value="none">Ordenar‚Ä¶</option>
                    <option value="nombre">Nombre (A-Z)</option>
                    <option value="costo">Costo unitario (‚Üë)</option>
                    <option value="subtotal">Subtotal (‚Üë)</option>
                    <option value="checked">Marcados primero</option>
                </select>
                <span class="total-cat" data-cat="alimentos">$0.00</span>
            </div>
        </header>
        <ul>
            <li><input type="checkbox" id="arroz"><label for="arroz">Arroz</label></li>
            <li><input type="checkbox" id="frijol"><label for="frijol">Frijol</label></li>
            <li><input type="checkbox" id="aceite"><label for="aceite">Aceite</label></li>
            <li><input type="checkbox" id="sal"><label for="sal">Sal</label></li>
            <li><input type="checkbox" id="azucar"><label for="azucar">Az√∫car</label></li>
            <li><input type="checkbox" id="harina"><label for="harina">Harina</label></li>
            <li><input type="checkbox" id="cafe"><label for="cafe">Caf√© / t√©</label></li>
        </ul>
    </div>

    <div class="card conservas">
        <header>
            <div class="left"><h2>Conservas <span class="contador"></span></h2></div>
            <div class="right">
                <select class="sort-select">
                    <option value="none">Ordenar‚Ä¶</option>
                    <option value="nombre">Nombre (A-Z)</option>
                    <option value="costo">Costo unitario (‚Üë)</option>
                    <option value="subtotal">Subtotal (‚Üë)</option>
                    <option value="checked">Marcados primero</option>
                </select>
                <span class="total-cat" data-cat="conservas">$0.00</span>
            </div>
        </header>
        <ul>
            <li><input type="checkbox" id="atun"><label for="atun">At√∫n en lata</label></li>
            <li><input type="checkbox" id="sopa"><label for="sopa">Sopa instant√°nea / sopas en sobre</label></li>
            <li><input type="checkbox" id="vegetales"><label for="vegetales">Vegetales enlatados</label></li>
            <li><input type="checkbox" id="fruta"><label for="fruta">Frutas enlatadas</label></li>
            <li><input type="checkbox" id="miel"><label for="miel">Miel / mantequilla</label></li>
            <li><input type="checkbox" id="jugo"><label for="jugo">Jugo en caja</label></li>
        </ul>
    </div>

    <div class="card otros">
        <header>
            <div class="left"><h2>Otros <span class="contador"></span></h2></div>
            <div class="right">
                <select class="sort-select">
                    <option value="none">Ordenar‚Ä¶</option>
                    <option value="nombre">Nombre (A-Z)</option>
                    <option value="costo">Costo unitario (‚Üë)</option>
                    <option value="subtotal">Subtotal (‚Üë)</option>
                    <option value="checked">Marcados primero</option>
                </select>
                <span class="total-cat" data-cat="otros">$0.00</span>
            </div>
        </header>
        <ul>
            <li><input type="checkbox" id="pilas"><label for="pilas">Pilas</label></li>
            <li><input type="checkbox" id="velas"><label for="velas">Velas</label></li>
            <li><input type="checkbox" id="cerillos"><label for="cerillos">Cerillos / encendedores</label></li>
            <li><input type="checkbox" id="pa√±ales"><label for="pa√±ales">Pa√±ales</label></li>
            <li><input type="checkbox" id="toallitas-bb"><label for="toallitas-bb">Toallitas beb√©</label></li>
        </ul>
    </div>

</div>

<script>
/* =================== UTILIDADES =================== */
const money = (v) => {
    const n = isFinite(v) ? Number(v) : 0;
    return n.toLocaleString('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2 });
};
const qS  = (sel, ctx=document) => ctx.querySelector(sel);
const qSA = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

/* =================== LOCAL STORAGE =================== */
const LS_KEY = 'despensa_v2_items';

function readStateFromDOM() {
    const data = [];
    qSA('.card').forEach(card => {
        const categoria = [...card.classList].find(c => ['higiene','limpieza','alimentos','conservas','otros'].includes(c));
        qSA('ul > li', card).forEach(li => {
            const chk = li.querySelector('input[type="checkbox"]');
            const label = li.querySelector('label');
            const id = chk?.id || label?.textContent.trim().toLowerCase().replace(/\s+/g,'-');
            const cant = Number(li.querySelector('.cant')?.value) || 0;
            const precio = Number(li.querySelector('.precio')?.value) || 0;
            data.push({
                id,
                nombre: label ? label.textContent.trim() : (id || ''),
                categoria,
                checked: !!chk?.checked,
                cantidad: cant,
                costo: precio
            });
        });
    });
    return data;
}
function saveState() {
    localStorage.setItem(LS_KEY, JSON.stringify(readStateFromDOM()));
}
function loadState() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
}
function applyState(state) {
    if (!state) return;
    // Index por id
    const map = new Map(state.map(i => [i.id, i]));
    qSA('.card').forEach(card => {
        qSA('ul > li', card).forEach(li => {
            const chk = li.querySelector('input[type="checkbox"]');
            const label = li.querySelector('label');
            const id = chk?.id || label?.textContent.trim().toLowerCase().replace(/\s+/g,'-');
            if (!id) return;
            const item = map.get(id);
            if (!item) return;
            if (chk) chk.checked = !!item.checked;
            const cant = li.querySelector('.cant');
            const precio = li.querySelector('.precio');
            if (cant) cant.value = (item.cantidad ?? 1);
            if (precio) precio.value = (item.costo ?? 0);
        });
    });
}

/* =================== COMPONENTES DE √çTEM =================== */
function addControlsToItem(li, nombreVisible='') {
    if (li.querySelector('.pc-wrap')) return;

    const wrap = document.createElement('div');
    wrap.className = 'pc-wrap';

    const cant = document.createElement('input');
    cant.type = 'number';
    cant.className = 'cant';
    cant.min = '0'; cant.step = '1';
    cant.value = '1'; cant.title = 'Cantidad';

    const precio = document.createElement('input');
    precio.type = 'number';
    precio.className = 'precio';
    precio.min = '0'; precio.step = '0.01';
    precio.placeholder = 'Costo $';
    precio.title = 'Costo unitario (MXN)';

    const subtotal = document.createElement('span');
    subtotal.className = 'subtotal';
    subtotal.textContent = money(0);

    const btnDel = document.createElement('button');
    btnDel.className = 'eliminar'; btnDel.type = 'button';
    btnDel.title = 'Eliminar'; btnDel.textContent = 'üóëÔ∏è';

    wrap.append(cant, precio, subtotal, btnDel);
    li.appendChild(wrap);

    const chk = li.querySelector('input[type="checkbox"]');

    const recalcItem = () => {
        const q = Number(cant.value) || 0;
        const p = Number(precio.value) || 0;
        subtotal.textContent = money(q * p);
        if (chk) li.classList.toggle('checked', chk.checked);
        updateAll();
        saveState();
    };

    cant.addEventListener('input', recalcItem);
    precio.addEventListener('input', recalcItem);
    if (chk) chk.addEventListener('change', () => { li.classList.toggle('checked', chk.checked); recalcItem(); });

    // Eliminar con confirmaci√≥n
    btnDel.addEventListener('click', () => {
        const overlay = document.createElement('div');
        overlay.className = 'overlay-confirm';
        overlay.innerHTML = `
            <div class="confirm-box">
                <p>¬øSeguro que quieres eliminar "<strong>${nombreVisible || li.innerText.trim()}</strong>"?</p>
                <div class="confirm-buttons">
                    <button class="btn-confirm yes">S√≠</button>
                    <button class="btn-confirm no">No</button>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
        overlay.querySelector('.yes').addEventListener('click', () => {
            li.style.transition = 'all 0.25s ease';
            li.style.opacity = 0; li.style.transform = 'translateX(-12px)';
            setTimeout(() => { li.remove(); updateAll(); saveState(); }, 220);
            overlay.remove();
        });
        overlay.querySelector('.no').addEventListener('click', () => overlay.remove());
    });
}

function prepareExistingItem(li) {
    const label = li.querySelector('label');
    const txt = label ? label.textContent.trim() : '';
    addControlsToItem(li, txt);

    const chk = li.querySelector('input[type="checkbox"]');
    if (chk) {
        li.classList.toggle('checked', chk.checked);
        chk.addEventListener('change', () => {
            li.classList.toggle('checked', chk.checked);
            updateAll();
            saveState();
        });
    }
}

/* =================== C√ÅLCULOS =================== */
function updateAll() {
    const barra = qS('#barra-progreso');
    let totalChecks = 0, seleccionados = 0, totalCantidad = 0, totalDinero = 0;

    // Totales por categor√≠a
    const perCat = { higiene:0, limpieza:0, alimentos:0, conservas:0, otros:0 };

    // Recolectar subtotales para marcar ‚Äúm√°s caros‚Äù
    const subtotales = [];

    qSA('.card').forEach(card => {
        const items = qSA('ul li', card);
        const checks = qSA('ul li input[type="checkbox"]', card);
        let checkedInCard = 0;
        let catKey = [...card.classList].find(c => perCat.hasOwnProperty(c));

        checks.forEach(chk => {
            totalChecks++;
            const li = chk.closest('li');
            const q = Number(li.querySelector('.cant')?.value) || 0;
            const p = Number(li.querySelector('.precio')?.value) || 0;
            const sub = q * p;
            if (sub > 0) subtotales.push({ li, sub });

            if (chk.checked) {
                checkedInCard++;
                totalCantidad += q;
                totalDinero += sub;
                if (catKey) perCat[catKey] += sub;
            }
        });

        const cont = card.querySelector('.contador');
        if (cont) cont.textContent = `(${checkedInCard}/${checks.length})`;
    });

    // Progreso
    const porcentaje = totalChecks ? Math.round((qSA('li input[type="checkbox"]:checked').length / totalChecks) * 100) : 0;
    barra.style.width = porcentaje + '%';
    barra.textContent = porcentaje === 100 ? 'üéâ Completado! üéâ' : (porcentaje + '%');

    // Globales
    qS('#total-seleccionados').textContent = qSA('li input[type="checkbox"]:checked').length;
    qS('#total-cantidad').textContent = totalCantidad;
    qS('#total-dinero').textContent = money(totalDinero);

    // Por categor√≠a
    qSA('.total-cat').forEach(span => {
        const k = span.getAttribute('data-cat');
        span.textContent = money(perCat[k] || 0);
    });

    // Marcar ‚Äúm√°s caros‚Äù: >= 90% del m√°ximo subtotal no-cero
    const maxSub = Math.max(0, ...subtotales.map(s => s.sub));
    const umbral = maxSub * 0.9;
    qSA('li').forEach(li => li.classList.remove('expensive'));
    if (maxSub > 0) {
        subtotales.forEach(({li, sub}) => {
            if (sub >= umbral) li.classList.add('expensive');
        });
    }
}

/* =================== ORDENAMIENTO =================== */
function sortList(ul, mode) {
    const lis = qSA(':scope > li', ul);
    const getName = (li) => (li.querySelector('label')?.textContent || '').trim().toLowerCase();
    const getCosto = (li) => Number(li.querySelector('.precio')?.value) || 0;
    const getSub = (li) => (Number(li.querySelector('.cant')?.value)||0) * (Number(li.querySelector('.precio')?.value)||0);
    const isChecked = (li) => !!li.querySelector('input[type="checkbox"]')?.checked;

    let arr = [...lis];
    switch (mode) {
        case 'nombre': arr.sort((a,b)=> getName(a).localeCompare(getName(b))); break;
        case 'costo' : arr.sort((a,b)=> getCosto(a) - getCosto(b)); break;
        case 'subtotal': arr.sort((a,b)=> getSub(a) - getSub(b)); break;
        case 'checked': arr.sort((a,b)=> Number(isChecked(b)) - Number(isChecked(a))); break;
        default: return;
    }
    arr.forEach(li => ul.appendChild(li));
}

/* =================== INICIO =================== */
document.addEventListener('DOMContentLoaded', () => {
    const cards = qSA('.card');
    const busqueda = qS('#busqueda');

    // Preparar todos los √≠tems existentes
    qSA('.card ul li').forEach(prepareExistingItem);

    // Intentar cargar estado guardado
    const state = loadState();
    if (state) applyState(state);

    // Filtro por texto
    busqueda.addEventListener('input', () => {
        const term = busqueda.value.toLowerCase();
        cards.forEach(card => {
            let matchCat = false;
            qSA('li', card).forEach(li => {
                const texto = li.innerText.toLowerCase();
                const visible = texto.includes(term);
                li.style.display = visible ? 'flex' : 'none';
                li.classList.toggle('highlight', visible && term !== '');
                if (visible) matchCat = true;
            });
            card.style.display = matchCat ? 'flex' : 'none';
        });
    });

    // Orden por categor√≠a
    qSA('.card .sort-select').forEach(sel => {
        sel.addEventListener('change', () => {
            const ul = sel.closest('.card').querySelector('ul');
            sortList(ul, sel.value);
            saveState();
        });
    });

    updateAll(); // inicial
    saveState(); // guardar estado inicial tras inyectar controles
});

/* =================== AGREGAR NUEVO PRODUCTO =================== */
qS('#agregar-producto').addEventListener('click', () => {
    const nombre = qS('#nuevo-producto').value.trim();
    const categoria = qS('#categoria-nueva').value;
    if (!nombre) return alert('Escribe un nombre de producto.');

    const ul = qS(`.card.${categoria} ul`);
    const id = nombre.toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-z0-9]+/g,'-');

    const li = document.createElement('li');
    li.innerHTML = `<input type="checkbox" id="${id}"><label for="${id}">${nombre}</label>`;
    ul.appendChild(li);

    prepareExistingItem(li);
    qS('#nuevo-producto').value = '';

    updateAll();
    saveState();
});

/* =================== IMPRESI√ìN =================== */
qS('#btn-imprimir').addEventListener('click', () => {
    const seleccionados = qSA('li input[type="checkbox"]:checked').map(chk => chk.closest('li'));
    if (seleccionados.length === 0) {
        alert('No hay productos seleccionados para imprimir.');
        return;
    }

    // Agrupar por categor√≠a
    const grupos = {};
    seleccionados.forEach(li => {
        const card = li.closest('.card');
        const categoria = [...card.classList].find(c => ['higiene','limpieza','alimentos','conservas','otros'].includes(c)) || 'otros';
        if (!grupos[categoria]) grupos[categoria] = [];
        grupos[categoria].push(li);
    });

    // Total global
    let totalGlobal = 0;

    const win = window.open('', '_blank');
    const css = `
        body{font-family:Segoe UI,Tahoma,Arial,sans-serif;padding:20px;}
        h1{margin:0 0 10px;}
        h2{margin:18px 0 8px;}
        table{width:100%;border-collapse:collapse;margin-bottom:16px;}
        th,td{border:1px solid #e5e7eb;padding:8px 10px;text-align:left;}
        th{background:#f3f4f6}
        tfoot td{font-weight:700}
    `;

    let html = `<html><head><meta charset="UTF-8"><title>Resumen de compra</title><style>${css}</style></head><body>`;
    html += `<h1>Resumen de compra</h1><small>${new Date().toLocaleString('es-MX')}</small>`;

    Object.entries(grupos).forEach(([cat, lis]) => {
        let totCat = 0;
        html += `<h2>${cat.charAt(0).toUpperCase()+cat.slice(1)}</h2>`;
        html += `<table><thead><tr><th>Producto</th><th>Cant.</th><th>Costo</th><th>Subtotal</th></tr></thead><tbody>`;
        lis.forEach(li => {
            const nombre = li.querySelector('label')?.textContent.trim() || '';
            const q = Number(li.querySelector('.cant')?.value)||0;
            const p = Number(li.querySelector('.precio')?.value)||0;
            const s = q * p;
            totCat += s;
            html += `<tr><td>${nombre}</td><td>${q}</td><td>${money(p)}</td><td>${money(s)}</td></tr>`;
        });
        html += `</tbody><tfoot><tr><td colspan="3">Total categor√≠a</td><td>${money(totCat)}</td></tr></tfoot></table>`;
        totalGlobal += totCat;
    });

    html += `<h2>Total</h2><p style="font-size:1.2rem;font-weight:700">${money(totalGlobal)}</p>`;
    html += `</body></html>`;

    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
});

/* =================== BORRAR ESTADO =================== */
qS('#btn-borrar').addEventListener('click', () => {
    const overlay = document.createElement('div');
    overlay.className = 'overlay-confirm';
    overlay.innerHTML = `
        <div class="confirm-box">
            <p>¬øBorrar todo el estado guardado (checks, cantidades, costos, orden)?</p>
            <div class="confirm-buttons">
                <button class="btn-confirm yes">S√≠</button>
                <button class="btn-confirm no">No</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);
    overlay.querySelector('.yes').addEventListener('click', () => {
        localStorage.removeItem(LS_KEY);
        window.location.reload();
    });
    overlay.querySelector('.no').addEventListener('click', () => overlay.remove());
});

/* =================== B√öSQUEDA EN VIVO =================== */
qS('#busqueda').addEventListener('input', function(){
    const term = this.value.toLowerCase();
    qSA('.card').forEach(card=>{
        let matchCat = false;
        qSA('li', card).forEach(li=>{
            const texto = li.innerText.toLowerCase();
            const visible = texto.includes(term);
            li.style.display = visible ? 'flex' : 'none';
            li.classList.toggle('highlight', visible && term!=='');
            if(visible) matchCat = true;
        });
        card.style.display = matchCat ? 'flex' : 'none';
    });
});
</script>

</body>
</html>
